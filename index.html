<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Red Eagle Company</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lottie for high-quality animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <!-- QR Code Scanner library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- ApexCharts for professional graphs -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Three.js for 3D logo -->
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js" } }
    </script>

    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #020617; /* Fallback background */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Aurora Background Animation */
        #aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .aurora-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            mix-blend-mode: screen;
        }

        #shape1 {
            width: 400px; height: 400px; background-color: #be123c;
            animation: move1 25s infinite alternate;
        }
        #shape2 {
            width: 300px; height: 300px; background-color: #4338ca;
            animation: move2 30s infinite alternate;
        }
         #shape3 {
            width: 350px; height: 350px; background-color: #166534;
            animation: move3 20s infinite alternate;
        }

        @keyframes move1 {
            from { transform: translate(10vw, 20vh) rotate(0deg); }
            to { transform: translate(70vw, 80vh) rotate(360deg); }
        }
        @keyframes move2 {
            from { transform: translate(80vw, 10vh); }
            to { transform: translate(20vw, 60vh); }
        }
         @keyframes move3 {
            from { transform: translate(50vw, 90vh); }
            to { transform: translate(10vw, 10vh); }
        }

        /* Glassmorphism Card Style */
        .card {
            position: relative;
            background-color: rgba(15, 23, 42, 0.6); /* Slightly more opaque */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Neon Glow Effect on Hover */
        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 0 15px rgba(225, 29, 72, 0.3), 0 0 30px rgba(225, 29, 72, 0.2), 0 0 45px rgba(225, 29, 72, 0.1);
            border-color: rgba(225, 29, 72, 0.5);
        }

        /* Page load animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(25px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in-up {
            opacity: 0;
            animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Activity log animation */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .activity-item {
            animation: slideIn 0.5s ease-out forwards;
        }

        /* Number Ticker Animation */
        .balance-ticker {
            transition: transform 0.4s ease-out;
            display: inline-block;
        }
        .balance-up {
            transform: translateY(-100%);
        }
        .balance-down {
            transform: translateY(100%);
        }

        /* QR Scanner styling */
        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #334155;
        }
        
        /* Modal Transitions */
        #payment-modal {
             transition: opacity 0.3s ease, visibility 0.3s;
        }
        #modal-content {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #payment-modal.modal-hidden { visibility: hidden; opacity: 0; }
        #payment-modal.modal-visible { visibility: visible; opacity: 1; }
        
        /* Chart tooltip styling */
        .apexcharts-tooltip {
            background: #1e293b !important;
            color: #e2e8f0;
            border: 1px solid #334155 !important;
        }
        .apexcharts-tooltip-title {
            background: #334155 !important;
            border-bottom: 1px solid #475569 !important;
        }

        /* PIN Entry styling */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        #pin-display.shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
        .pin-dot.filled {
            background-color: #f43f5e; /* rose-500 */
            transform: scale(1.1);
        }
        .keypad-btn:active {
            transform: scale(0.95);
            background-color: #be123c; /* rose-700 */
        }
    </style>
</head>
<body class="text-white antialiased">

    <div id="aurora-bg">
        <div id="shape1" class="aurora-shape"></div>
        <div id="shape2" class="aurora-shape"></div>
        <div id="shape3" class="aurora-shape"></div>
    </div>

    <div id="app" class="relative z-10 min-h-screen p-4 sm:p-6 lg:p-8 flex flex-col max-w-4xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 animate-fade-in-up" style="animation-delay: 100ms;">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="w-10 h-10"></div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-slate-200">The Red Eagle Co.</h1>
            </div>
            <div class="text-right">
                <p id="greeting" class="text-sm md:text-base text-slate-400">Hi Aryaveer, Good Morning!</p>
                <div class="flex items-center justify-end gap-2 mt-1">
                    <span id="market-status-indicator" class="h-2.5 w-2.5 rounded-full bg-gray-500 transition-colors"></span>
                    <p id="market-status" class="text-xs font-semibold uppercase tracking-wider text-slate-300">Market Closed</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Wallet Balance Card -->
            <div class="card mb-8 animate-fade-in-up" style="animation-delay: 200ms;">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm font-medium mb-2">Total Wallet Balance</p>
                        <div class="flex items-end gap-3">
                            <div class="text-4xl md:text-5xl font-extrabold text-slate-50 tracking-tight transition-colors duration-500 h-[48px] overflow-hidden" style="line-height: 48px;">
                                <span id="wallet-balance-ticker" class="balance-ticker">₹52,987.00</span>
                            </div>
                        </div>
                    </div>
                    <div id="sparkline-container" class="mt-2">
                        <div id="sparkline-chart"></div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Snapshot -->
            <div class="card mb-8 animate-fade-in-up" style="animation-delay: 300ms;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-slate-200">Portfolio Snapshot</h2>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div>
                        <p class="text-sm text-slate-400">Today's P&L</p>
                        <p id="todays-pnl" class="text-2xl font-bold text-slate-400 transition-colors duration-500">₹0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Total P&L</p>
                        <p id="total-pnl" class="text-2xl font-bold text-slate-400 transition-colors duration-500">₹0.00</p>
                    </div>
                </div>
                <div>
                    <p class="text-xs text-slate-400 mb-2 text-center font-medium">Weekly Performance</p>
                    <div id="pnl-candlestick-chart" class="w-full h-48 -mb-4"></div>
                </div>
            </div>


            <!-- Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card animate-fade-in-up" style="animation-delay: 400ms;">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-200 mb-1">UPI Payments</h2>
                        <p class="text-slate-400 text-sm mb-6">Scan any QR code to pay instantly from your wallet.</p>
                    </div>
                    <button id="pay-btn" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg shadow-rose-900/40 mt-auto">
                        Scan QR & Pay
                    </button>
                </div>
                
                <div class="card animate-fade-in-up" style="animation-delay: 500ms;">
                     <h2 class="text-lg font-semibold text-slate-200 mb-1">Recent Activity</h2>
                     <p class="text-slate-400 text-sm mb-6">Live portfolio updates will appear here when the market is open.</p>
                     <div id="activity-log" class="space-y-3 text-sm">
                        <p class="text-slate-500 italic">No recent activity.</p>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UPI Payment Modal -->
    <div id="payment-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-slate-800/80 backdrop-blur-xl border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl text-center relative transform scale-95">
             <button id="close-modal-btn" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors h-10 w-10 flex items-center justify-center text-2xl font-bold">&times;</button>
            
            <div id="scanner-view">
                <h2 class="text-xl font-bold mb-2">Scan UPI QR Code</h2>
                <p class="text-slate-400 mb-4 text-sm">Hold the QR code within the frame.</p>
                <div id="qr-reader" class="w-full mx-auto"></div>
                <p id="scanner-error" class="text-red-400 text-sm mt-2 hidden"></p>
            </div>

            <div id="details-view" class="hidden">
                 <h2 class="text-xl font-bold mb-2">Confirm Payment</h2>
                 <p class="text-slate-400 mb-6 text-sm">You are paying:</p>
                 <div class="bg-slate-700/50 rounded-xl p-4 mb-4 text-left">
                     <p class="text-xs text-slate-400">NAME</p>
                     <p id="payee-name" class="font-semibold text-lg"></p>
                     <p class="text-xs text-slate-400 mt-2">UPI ID</p>
                     <p id="payee-upi" class="font-mono text-sm"></p>
                 </div>
                 <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-bold text-slate-400">₹</span>
                    <input type="number" id="amount-input" placeholder="0.00" class="w-full bg-slate-900 border-2 border-slate-600 focus:border-rose-500 focus:ring-0 rounded-lg text-center text-3xl font-bold py-3 transition-colors">
                 </div>
                 <p id="amount-error" class="text-red-400 text-sm mt-2 hidden">Invalid amount.</p>
                 <button id="confirm-pay-btn" class="w-full mt-6 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105">Pay Now</button>
            </div>

            <div id="pin-view" class="hidden">
                <button id="back-to-details-btn" class="absolute top-3 left-3 text-slate-400 hover:text-white transition-colors h-10 w-10 flex items-center justify-center text-2xl font-bold rounded-full hover:bg-slate-700/50">&larr;</button>
                <h2 class="text-xl font-bold mb-4">Enter Security PIN</h2>
                <div id="pin-display" class="flex justify-center gap-4 my-6">
                    <div class="pin-dot h-4 w-4 bg-slate-600 rounded-full transition-all duration-200"></div>
                    <div class="pin-dot h-4 w-4 bg-slate-600 rounded-full transition-all duration-200"></div>
                    <div class="pin-dot h-4 w-4 bg-slate-600 rounded-full transition-all duration-200"></div>
                    <div class="pin-dot h-4 w-4 bg-slate-600 rounded-full transition-all duration-200"></div>
                </div>
                <p id="pin-error" class="text-red-400 text-sm h-5 mb-2"></p>
                <div id="pin-keypad" class="grid grid-cols-3 gap-4 text-2xl font-bold">
                    <button data-key="1" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">1</button>
                    <button data-key="2" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">2</button>
                    <button data-key="3" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">3</button>
                    <button data-key="4" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">4</button>
                    <button data-key="5" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">5</button>
                    <button data-key="6" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">6</button>
                    <button data-key="7" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">7</button>
                    <button data-key="8" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">8</button>
                    <button data-key="9" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">9</button>
                    <div class="aspect-square"></div> <!-- empty cell -->
                    <button data-key="0" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors">0</button>
                    <button data-key="del" class="keypad-btn bg-slate-700/50 hover:bg-slate-700 rounded-full p-4 aspect-square transition-colors flex justify-center items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    </button>
                </div>
            </div>

            <div id="confirmation-view" class="hidden">
                <lottie-player id="success-animation" src="https://assets10.lottiefiles.com/packages/lf20_jbrw3hcz.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: auto;"></lottie-player>
                <h2 class="text-2xl font-bold text-green-400 mt-4">Payment Successful!</h2>
                <p class="text-slate-300">Your transaction has been completed.</p>
                <button id="done-btn" class="w-full mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-xl transition">Done</button>
            </div>

            <div id="loading-view" class="hidden">
                <lottie-player src="https://lottie.host/80b53818-f252-45e0-94d7-83b6329a4358/eY0Jj15GfR.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: auto;" loop autoplay></lottie-player>
                <h2 class="text-xl font-semibold text-slate-300 animate-pulse">Securing Transaction...</h2>
            </div>
        </div>
    </div>


    <script type="module">
        import * as THREE from 'three';

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & ELEMENTS ---
            const initialInvestedValue = 52987.00;
            let walletBalance = 52987.00;
            let todaysPnl = 0;
            let enteredPin = '';
            let html5QrCode = null;
            let simulationInterval = null; 
            let sparklineChart, pnlChart;
            
            // Default data for first-time use
            let weeklyPnlData = [
                { x: new Date('2025-09-01').getTime(), y: [52850.15, 52980.60, 52600.90, 52636.55] },
                { x: new Date('2025-09-02').getTime(), y: [52630.10, 53250.75, 52580.20, 53066.65] },
                { x: new Date('2025-09-03').getTime(), y: [53060.00, 53100.80, 52850.00, 52956.65] },
                { x: new Date('2025-09-04').getTime(), y: [52960.25, 53750.10, 52950.50, 53606.40] },
                { x: new Date('2025-09-05').getTime(), y: [53600.90, 53880.00, 53500.25, 53826.70] },
                { x: new Date().setHours(0,0,0,0), y: [initialInvestedValue, initialInvestedValue, initialInvestedValue, initialInvestedValue] }
            ];

            // --- ELEMENTS ---
            const greetingEl = document.getElementById('greeting');
            const marketStatusEl = document.getElementById('market-status');
            const marketStatusIndicatorEl = document.getElementById('market-status-indicator');
            const walletBalanceTickerEl = document.getElementById('wallet-balance-ticker');
            const activityLogEl = document.getElementById('activity-log');
            const todaysPnlEl = document.getElementById('todays-pnl');
            const totalPnlEl = document.getElementById('total-pnl');
            const modalElements = {
                paymentModal: document.getElementById('payment-modal'),
                modalContent: document.getElementById('modal-content'),
                payBtn: document.getElementById('pay-btn'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                scannerView: document.getElementById('scanner-view'),
                detailsView: document.getElementById('details-view'),
                confirmationView: document.getElementById('confirmation-view'),
                loadingView: document.getElementById('loading-view'),
                payeeNameEl: document.getElementById('payee-name'),
                payeeUpiEl: document.getElementById('payee-upi'),
                amountInput: document.getElementById('amount-input'),
                amountError: document.getElementById('amount-error'),
                confirmPayBtn: document.getElementById('confirm-pay-btn'),
                doneBtn: document.getElementById('done-btn'),
                successAnimation: document.getElementById('success-animation'),
                pinView: document.getElementById('pin-view'),
                pinDisplay: document.getElementById('pin-display'),
                pinKeypad: document.getElementById('pin-keypad'),
                pinError: document.getElementById('pin-error'),
                backToDetailsBtn: document.getElementById('back-to-details-btn'),
            };

            // --- 3D LOGO SETUP ---
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            const logoContainer = document.getElementById('logo-container');
            renderer.setSize(40, 40);
            logoContainer.appendChild(renderer.domElement);
            
            const geometry = new THREE.IcosahedronGeometry(0.8, 0);
            const material = new THREE.MeshStandardMaterial({
                color: 0xe11d48,
                metalness: 0.6,
                roughness: 0.3
            });
            const logo = new THREE.Mesh(geometry, material);
            scene.add(logo);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
            
            camera.position.z = 2;

            function animateLogo() {
                requestAnimationFrame(animateLogo);
                logo.rotation.x += 0.005;
                logo.rotation.y += 0.005;
                renderer.render(scene, camera);
            }
            animateLogo();


            // --- CHART SETUP ---
            function initCharts() {
                const sparklineData = weeklyPnlData.map(d => d.y[3]);
                if (sparklineData[sparklineData.length-1] !== walletBalance) {
                     sparklineData[sparklineData.length-1] = walletBalance;
                }
                
                const sparklineOptions = {
                    series: [{ data: sparklineData }],
                    chart: { type: 'area', height: 60, width: 120, sparkline: { enabled: true } },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: {
                        type: 'gradient',
                        gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1, }
                    },
                    colors: [todaysPnl >= 0 ? '#4ade80' : '#f87171'],
                    tooltip: { enabled: false }
                };
                sparklineChart = new ApexCharts(document.querySelector("#sparkline-chart"), sparklineOptions);
                sparklineChart.render();
                
                const pnlChartOptions = {
                    series: [{ data: weeklyPnlData }],
                    chart: { type: 'candlestick', height: '100%', toolbar: { show: false }, background: 'transparent' },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#94a3b8' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { show: false }, grid: { show: false } },
                    grid: { show: true, borderColor: 'rgba(148, 163, 184, 0.1)', padding: { left: 0, right: 0 } },
                    plotOptions: {
                        candlestick: {
                            colors: { upward: '#22c55e', downward: '#ef4444' },
                            wick: { useFillColor: true }
                        }
                    },
                    tooltip: { theme: 'dark' }
                };
                pnlChart = new ApexCharts(document.querySelector("#pnl-candlestick-chart"), pnlChartOptions);
                pnlChart.render();
            }

            // --- LOCAL STORAGE FUNCTIONS ---
            function saveState() {
                const state = {
                    walletBalance: walletBalance,
                    todaysPnl: todaysPnl,
                    weeklyPnlData: weeklyPnlData,
                    activityLogHTML: activityLogEl.innerHTML,
                    lastSavedDate: new Date().toISOString()
                };
                localStorage.setItem('redEagleState', JSON.stringify(state));
            }

            function loadState() {
                const savedStateJSON = localStorage.getItem('redEagleState');
                if (!savedStateJSON) return;

                const savedState = JSON.parse(savedStateJSON);
                const lastSaved = new Date(savedState.lastSavedDate).toDateString();
                const today = new Date().toDateString();

                walletBalance = savedState.walletBalance;
                weeklyPnlData = savedState.weeklyPnlData;

                if (lastSaved === today) {
                    todaysPnl = savedState.todaysPnl;
                    if (savedState.activityLogHTML) activityLogEl.innerHTML = savedState.activityLogHTML;
                } else {
                    todaysPnl = 0;
                    const lastClose = weeklyPnlData[weeklyPnlData.length - 1].y[3];
                    weeklyPnlData.push({
                        x: new Date().setHours(0,0,0,0),
                        y: [lastClose, lastClose, lastClose, lastClose]
                    });
                    if (weeklyPnlData.length > 7) weeklyPnlData.shift();
                }

                walletBalanceTickerEl.textContent = `₹${walletBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                updatePnlUI();
            }

            // --- UI & LOGIC FUNCTIONS ---
            function updatePnlUI() {
                const totalPnl = walletBalance - initialInvestedValue;
                todaysPnlEl.textContent = `₹${todaysPnl.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                totalPnlEl.textContent = `₹${totalPnl.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                [todaysPnlEl, totalPnlEl].forEach(el => {
                    const val = el === todaysPnlEl ? todaysPnl : totalPnl;
                    el.classList.toggle('text-green-400', val >= 0);
                    el.classList.toggle('text-red-400', val < 0);
                });
            }

            function animateBalance(newBalance) {
                const newSpan = document.createElement('span');
                newSpan.textContent = `₹${newBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                newSpan.className = 'balance-ticker';
                const isGain = newBalance > walletBalance;
                walletBalanceTickerEl.classList.add(isGain ? 'balance-down' : 'balance-up');
                
                setTimeout(() => {
                    walletBalanceTickerEl.innerHTML = '';
                    walletBalanceTickerEl.appendChild(newSpan);
                    walletBalanceTickerEl.classList.remove('balance-down', 'balance-up');
                }, 400);
            }

            function updateDashboard() {
                const now = new Date();
                const istOffset = 5.5 * 60 * 60 * 1000;
                const istTime = new Date(now.getTime() + istOffset);
                const hour = istTime.getUTCHours();
                const day = istTime.getUTCDay();

                if (hour < 12) greetingEl.textContent = "Hi Aryaveer, Good Morning!";
                else if (hour < 17) greetingEl.textContent = "Hi Aryaveer, Good Afternoon!";
                else greetingEl.textContent = "Hi Aryaveer, Good Evening!";

                const minutes = istTime.getUTCMinutes();
                const timeInMinutes = hour * 60 + minutes;
                const marketOpen = (day >= 1 && day <= 5) && (timeInMinutes >= (9 * 60 + 15) && timeInMinutes < (15 * 60 + 30));

                if (marketOpen) {
                    marketStatusEl.textContent = "Market Open";
                    marketStatusIndicatorEl.classList.remove('bg-gray-500');
                    marketStatusIndicatorEl.classList.add('bg-green-500', 'animate-pulse');
                    if (!simulationInterval) {
                        if(activityLogEl.querySelector('.italic')) activityLogEl.innerHTML = '';
                        simulationInterval = setInterval(autoSimulateBalance, 2500);
                    }
                } else {
                    marketStatusEl.textContent = "Market Closed";
                    marketStatusIndicatorEl.classList.add('bg-gray-500');
                    marketStatusIndicatorEl.classList.remove('bg-green-500', 'animate-pulse');
                    if (simulationInterval) {
                        clearInterval(simulationInterval);
                        simulationInterval = null;
                        if(!activityLogEl.hasChildNodes() || activityLogEl.querySelector('.italic')) {
                             activityLogEl.innerHTML = '<p class="text-slate-500 italic">Market is closed. No new activity.</p>';
                        }
                    }
                }
            }
            
            function updateBalance(newBalance, change) {
                animateBalance(newBalance);
                walletBalance = newBalance;
                todaysPnl += change;
                
                let todayData = weeklyPnlData[weeklyPnlData.length - 1].y;
                todayData[3] = walletBalance; // Close price
                if (walletBalance > todayData[1]) todayData[1] = walletBalance; // High
                if (walletBalance < todayData[2]) todayData[2] = walletBalance; // Low

                sparklineChart.updateSeries([{ data: weeklyPnlData.map(d => d.y[3]) }]);
                sparklineChart.updateOptions({ colors: [todaysPnl >= 0 ? '#4ade80' : '#f87171']});
                pnlChart.updateSeries([{ data: weeklyPnlData }]);

                updatePnlUI();

                if (change !== 0) {
                    if (activityLogEl.querySelector('.italic')) activityLogEl.innerHTML = '';
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                    const logEntry = document.createElement('div');
                    logEntry.className = 'activity-item flex justify-between items-center';
                    const changeType = change > 0 ? 'Portfolio Gain' : 'Portfolio Loss';
                    const textColor = change > 0 ? 'text-green-400' : 'text-red-400';
                    logEntry.innerHTML = `<div><span class="font-semibold">${changeType}</span><span class="text-xs text-slate-400 ml-2">${timeString}</span></div><span class="font-semibold ${textColor}">${change > 0 ? '+' : ''}₹${Math.abs(change).toFixed(2)}</span>`;
                    activityLogEl.prepend(logEntry);
                    
                    while (activityLogEl.children.length > 5) activityLogEl.removeChild(activityLogEl.lastChild);
                }
                
                saveState();
            }

            function autoSimulateBalance() {
                const change = (Math.random() - 0.49) * 400;
                updateBalance(walletBalance + change, change);
            }

            // --- MODAL & PAYMENT LOGIC ---
            function openModal() {
                modalElements.paymentModal.classList.remove('modal-hidden');
                modalElements.paymentModal.classList.add('modal-visible');
                setTimeout(() => modalElements.modalContent.classList.remove('scale-95'), 10);
                startScanner();
            }
            function closeModal() {
                modalElements.modalContent.classList.add('scale-95');
                modalElements.paymentModal.classList.remove('modal-visible');
                modalElements.paymentModal.classList.add('modal-hidden');
                setTimeout(() => { stopScanner(); resetModalViews(); }, 300);
            }
            function resetModalViews() {
                modalElements.scannerView.style.display = 'block';
                modalElements.detailsView.style.display = 'none';
                modalElements.confirmationView.style.display = 'none';
                modalElements.loadingView.style.display = 'none';
                modalElements.pinView.style.display = 'none';
                modalElements.amountInput.value = '';
                modalElements.amountError.classList.add('hidden');
                document.getElementById('scanner-error').classList.add('hidden');
                enteredPin = '';
                updatePinDisplay();
                modalElements.pinError.textContent = '';
            }
            function startScanner() {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(() => {
                        const scannerError = document.getElementById('scanner-error');
                        scannerError.textContent = "Could not start camera.";
                        scannerError.classList.remove('hidden');
                    });
            }
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("QR scanner stop failed.", err));
                }
            }
            function onScanSuccess(decodedText) {
                stopScanner();
                try {
                    const url = new URL(decodedText);
                    if (url.protocol !== 'upi:') throw new Error("Not a valid UPI QR code.");
                    const params = url.searchParams;
                    const upiId = params.get('pa');
                    if (!upiId) throw new Error("UPI ID not found in QR code.");
                    
                    modalElements.payeeNameEl.textContent = decodeURIComponent(params.get('pn') || 'N/A');
                    modalElements.payeeUpiEl.textContent = upiId;
                    modalElements.scannerView.style.display = 'none';
                    modalElements.detailsView.style.display = 'block';
                } catch (error) {
                    const scannerError = document.getElementById('scanner-error');
                    scannerError.textContent = error.message;
                    scannerError.classList.remove('hidden');
                    setTimeout(startScanner, 2000);
                }
            }
            function onScanFailure(error) { /* intentionally blank */ }
            
            function showPinView() {
                const amount = parseFloat(modalElements.amountInput.value);
                if (isNaN(amount) || amount <= 0 || amount > walletBalance) {
                    modalElements.amountError.textContent = amount > walletBalance ? "Insufficient balance." : "Invalid amount.";
                    modalElements.amountError.classList.remove('hidden');
                    return;
                }
                modalElements.amountError.classList.add('hidden');
                modalElements.detailsView.style.display = 'none';
                modalElements.pinView.style.display = 'block';
            }

            function updatePinDisplay() {
                const dots = modalElements.pinDisplay.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].classList.toggle('filled', i < enteredPin.length);
                }
            }

            function handlePinKeyPress(key) {
                if (key === 'del') {
                    enteredPin = enteredPin.slice(0, -1);
                } else if (enteredPin.length < 4) {
                    enteredPin += key;
                }
                
                updatePinDisplay();

                if (enteredPin.length === 4) {
                    checkPin();
                }
            }

            function checkPin() {
                const correctPin = '2580';
                modalElements.pinKeypad.style.pointerEvents = 'none';

                setTimeout(() => {
                    if (enteredPin === correctPin) {
                        finalizePayment();
                    } else {
                        modalElements.pinError.textContent = 'Incorrect PIN. Please try again.';
                        modalElements.pinDisplay.classList.add('shake');
                        
                        setTimeout(() => {
                            enteredPin = '';
                            updatePinDisplay();
                            modalElements.pinDisplay.classList.remove('shake');
                            modalElements.pinError.textContent = '';
                            modalElements.pinKeypad.style.pointerEvents = 'auto';
                        }, 1000);
                    }
                }, 200);
            }

            function finalizePayment() {
                modalElements.pinView.style.display = 'none';
                modalElements.loadingView.style.display = 'block';

                setTimeout(() => {
                    const amount = parseFloat(modalElements.amountInput.value);
                    const newBalance = walletBalance - amount;
                    updateBalance(newBalance, 0); // Update balance without P&L change
                    
                    modalElements.loadingView.style.display = 'none';
                    modalElements.confirmationView.style.display = 'block';
                    modalElements.successAnimation.seek(0);
                    modalElements.successAnimation.play();
                }, 2000);
            }

            // --- EVENT LISTENERS ---
            modalElements.payBtn.addEventListener('click', openModal);
            modalElements.closeModalBtn.addEventListener('click', closeModal);
            modalElements.doneBtn.addEventListener('click', closeModal);
            modalElements.confirmPayBtn.addEventListener('click', showPinView);
            modalElements.paymentModal.addEventListener('click', (e) => {
                if(e.target === modalElements.paymentModal) closeModal();
            });
            modalElements.backToDetailsBtn.addEventListener('click', () => {
                modalElements.pinView.style.display = 'none';
                modalElements.detailsView.style.display = 'block';
                enteredPin = '';
                updatePinDisplay();
            });
            modalElements.pinKeypad.addEventListener('click', (e) => {
                const button = e.target.closest('.keypad-btn');
                if (button) {
                    handlePinKeyPress(button.dataset.key);
                }
            });

            // --- INITIALIZATION ---
            loadState();
            initCharts();
            updateDashboard();
            setInterval(updateDashboard, 60000);
            window.addEventListener('resize', () => {
                if(pnlChart) pnlChart.destroy();
                if(sparklineChart) sparklineChart.destroy();
                initCharts();
            });
        });
    </script>

</body>
</html>

