<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit Pulse - Daily Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekOfYear.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_weekday);
        dayjs.extend(dayjs_plugin_weekOfYear);
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --brand-indigo: #6366F1;
            --brand-purple: #8B5CF6;
            --background-dark: #0a0a0a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: #e5e5e5;
            -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            background: radial-gradient(circle at top left, #0a0a0a 0%, #14141e 50%, #0a0a0a 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--brand-indigo), var(--brand-purple));
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .calendar-day { transition: all 0.2s ease; }
        .calendar-day.active {
            background: var(--brand-indigo);
            color: white;
            transform: scale(1.1);
        }
        .calendar-day:not(.active):hover { background: var(--card-bg); }
        .workout-item { border-left: 4px solid var(--brand-purple); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--brand-purple); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand-indigo); }

        /* Timer Styles */
        #timer-progress-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .pulsate { animation: pulsate 2s infinite ease-in-out; }
        @keyframes pulsate {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="main-container">

    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto animate-fade-in">
        <header class="flex justify-between items-center mb-8 animate-slide-up" style="animation-delay: 0.1s;">
             <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wider">Fit Pulse</h1>
            </div>
            <div id="current-date" class="hidden md:block text-lg font-medium text-gray-400"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Weekly Planner</h2>
                        <div class="flex items-center gap-2">
                            <button id="prev-week" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            </button>
                            <span id="current-month-year" class="font-semibold w-28 text-center"></span>
                            <button id="next-week" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="calendar-container" class="grid grid-cols-7 gap-2 md:gap-4"></div>
                </div>

                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 sm:gap-0">
                        <div>
                            <h2 class="text-xl font-bold text-white">Today's Plan</h2>
                            <p id="selected-date-display" class="text-gray-400"></p>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button id="ai-generate-btn" class="btn-secondary font-semibold py-2 px-4 rounded-lg flex items-center gap-2 w-full sm:w-auto">✨ Generate with AI</button>
                            <button id="add-workout-btn" class="btn-primary font-semibold py-2 px-4 rounded-lg flex items-center gap-2 w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add Workout
                            </button>
                        </div>
                    </div>
                    <div id="workout-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div class="space-y-8">
                <div id="workout-templates-card" class="glass-card p-6 animate-slide-up cursor-pointer" style="animation-delay: 0.4s;">
                     <h2 class="text-xl font-bold text-white mb-2">Workout Templates</h2>
                     <p class="text-gray-400 text-sm">Get started quickly with pre-made workout plans.</p>
                </div>
                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.5s;">
                    <h2 class="text-xl font-bold text-white mb-4">Weekly Progress</h2>
                    <div id="progress-container" class="flex justify-around items-end h-32"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container">
        <!-- Add/Edit Workout Modal -->
        <div id="workout-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-indigo-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 id="workout-modal-title" class="text-2xl font-bold mb-4 text-white"></h2>
                <form id="workout-form">
                    <input type="hidden" id="workout-id">
                    <div class="mb-4">
                        <label for="workout-name" class="block text-sm font-medium text-gray-300 mb-1">Workout Name</label>
                        <input type="text" id="workout-name" placeholder="e.g., Chest Day" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label for="workout-type" class="block text-sm font-medium text-gray-300 mb-1">Workout Type</label>
                        <select id="workout-type" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <option>Strength</option> <option>Cardio</option> <option>Flexibility</option> <option>Rest Day</option>
                        </select>
                    </div>
                     <div class="mb-6">
                        <label for="workout-duration" class="block text-sm font-medium text-gray-300 mb-1">Duration (minutes)</label>
                        <input type="number" id="workout-duration" placeholder="e.g., 60" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                    </div>
                    <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Save Workout</button>
                </form>
            </div>
        </div>
        <!-- Workout Log Modal -->
        <div id="log-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-green-500/50 relative animate-slide-up">
                 <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                 </button>
                <form id="log-form"></form>
            </div>
        </div>
        <!-- Template Select Modal -->
        <div id="template-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-lg p-6 rounded-2xl border-2 border-purple-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 text-white">Choose a Template</h2>
                <div id="template-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
        <!-- Timer Modal -->
        <div id="timer-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center p-4 z-50 hidden animate-fade-in">
            <div class="relative w-64 h-64 flex items-center justify-center mb-8">
                <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="timer-progress-circle" class="text-indigo-400" stroke-width="5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <div id="time-display" class="text-5xl font-bold text-white z-10">00:00</div>
            </div>
            <h3 id="timer-workout-name" class="text-xl font-semibold mb-8 text-gray-300"></h3>
            <div class="flex items-center gap-6">
                <button id="pause-resume-btn" class="text-gray-300 hover:text-white transition-colors p-4 bg-white/10 rounded-full">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button id="stop-timer-btn" class="text-gray-300 hover:text-white transition-colors p-4 bg-red-500/20 hover:bg-red-500/40 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                </button>
            </div>
        </div>
        <!-- AI Generator Modal -->
        <div id="ai-generator-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-purple-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 text-white">✨ AI Workout Generator</h2>
                <form id="ai-generator-form">
                    <div class="mb-4">
                        <label for="ai-goal" class="block text-sm font-medium text-gray-300 mb-1">What is your primary goal?</label>
                        <select id="ai-goal" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                            <option>Build Muscle</option>
                            <option>Lose Weight</option>
                            <option>Improve Endurance</option>
                            <option>Increase Flexibility</option>
                            <option>General Fitness</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="ai-equipment" class="block text-sm font-medium text-gray-300 mb-1">What equipment do you have?</label>
                        <input type="text" id="ai-equipment" placeholder="e.g., dumbbells, resistance bands" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                     <div class="mb-6">
                        <label for="ai-duration" class="block text-sm font-medium text-gray-300 mb-1">Workout Duration (minutes)</label>
                        <input type="number" id="ai-duration" value="45" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" required>
                    </div>
                    <p id="ai-error-msg" class="text-red-400 text-sm mb-4 text-center"></p>
                    <button id="ai-submit-btn" type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                        <span id="ai-submit-text">Generate Workout</span>
                        <svg id="ai-spinner" class="spinner h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
        <!-- Explanation Modal -->
        <div id="explanation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
            <div class="glass-card w-full max-w-lg p-6 rounded-2xl border-2 border-sky-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 id="explanation-title" class="text-2xl font-bold mb-4 text-white"></h2>
                <div id="explanation-content" class="text-gray-300 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONSTANTS ---
            let currentDate = dayjs();
            let selectedDate = dayjs().format('YYYY-MM-DD');
            let workouts = JSON.parse(localStorage.getItem('fitPulseWorkouts')) || {};
            
            let timerInterval;
            let timeRemaining;
            let totalTime;
            let isPaused = false;

            // --- ICONS & TEMPLATES DATA ---
            const ICONS = {
                Strength: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M12 1a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M12 18a9 9 0 0 0 9-9h-1.09a7 7 0 0 1-1.42 4.22l-1.42 1.42a3 3 0 0 0-4.14 0l-1.42-1.42A7 7 0 0 1 4.09 9H3a9 9 0 0 0 9 9z"></path></svg>`,
                Cardio: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>`,
                Flexibility: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400"><path d="M12.83 2.17a2 2 0 0 0-1.66 0L2.6 6.33a2 2 0 0 0-1 1.73v7.88a2 2 0 0 0 1 1.73l8.53 4.16a2 2 0 0 0 1.66 0l8.53-4.16a2 2 0 0 0 1-1.73V8.06a2 2 0 0 0-1-1.73Z"></path><path d="m12 14 4-4"></path><path d="m16 14-4-4"></path><path d="m8 10 4 4"></path></svg>`,
                'Rest Day': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>`
            };

            const WORKOUT_TEMPLATES = [
                { name: "Full Body Strength", plan: [ { d:0, n:"Upper Body Strength", type:"Strength", min:60 }, { d:2, n:"Lower Body Power", type:"Strength", min:60 }, { d:4, n:"Core & Back", type:"Strength", min:45 }, { d:6, n:"Full Body HIIT", type:"Cardio", min:30 } ] },
                { name: "Cardio Blast", plan: [ { d:0, n:"Running Intervals", type:"Cardio", min:30 }, { d:1, n:"Cycling", type:"Cardio", min:45 }, { d:3, n:"HIIT Cardio", type:"Cardio", min:25 }, { d:5, n:"Long Steady Run", type:"Cardio", min:60 } ] },
                { name: "Flexibility & Flow", plan: [ { d:0, n:"Morning Yoga", type:"Flexibility", min:30 }, { d:2, n:"Deep Stretch", type:"Flexibility", min:45 }, { d:4, n:"Restorative Yoga", type:"Flexibility", min:60 } ] }
            ];

            // --- DOM ELEMENTS ---
            const allElements = {
                currentDateEl: document.getElementById('current-date'),
                calendarContainer: document.getElementById('calendar-container'),
                currentMonthYearEl: document.getElementById('current-month-year'),
                selectedDateDisplay: document.getElementById('selected-date-display'),
                workoutList: document.getElementById('workout-list'),
                progressContainer: document.getElementById('progress-container'),
                workoutModal: document.getElementById('workout-modal'),
                workoutModalTitle: document.getElementById('workout-modal-title'),
                workoutForm: document.getElementById('workout-form'),
                workoutIdInput: document.getElementById('workout-id'),
                workoutNameInput: document.getElementById('workout-name'),
                workoutTypeInput: document.getElementById('workout-type'),
                workoutDurationInput: document.getElementById('workout-duration'),
                logModal: document.getElementById('log-modal'),
                logForm: document.getElementById('log-form'),
                templateModal: document.getElementById('template-modal'),
                templateList: document.getElementById('template-list'),
                timerModal: document.getElementById('timer-modal'),
                timeDisplay: document.getElementById('time-display'),
                timerProgressCircle: document.getElementById('timer-progress-circle'),
                timerWorkoutName: document.getElementById('timer-workout-name'),
                pauseResumeBtn: document.getElementById('pause-resume-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                aiGeneratorModal: document.getElementById('ai-generator-modal'),
                aiGeneratorForm: document.getElementById('ai-generator-form'),
                aiSubmitBtn: document.getElementById('ai-submit-btn'),
                aiSubmitText: document.getElementById('ai-submit-text'),
                aiSpinner: document.getElementById('ai-spinner'),
                explanationModal: document.getElementById('explanation-modal'),
                explanationTitle: document.getElementById('explanation-title'),
                explanationContent: document.getElementById('explanation-content'),
            };

            // --- CORE FUNCTIONS ---
            const saveAndRerender = () => {
                localStorage.setItem('fitPulseWorkouts', JSON.stringify(workouts));
                renderCalendar();
                renderWorkouts();
                renderProgress();
            };

            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            const findWorkoutById = (workoutId) => {
                if (!workouts[selectedDate]) return null;
                return workouts[selectedDate].find(w => w.id === workoutId);
            };

            // --- RENDERING FUNCTIONS ---
            const renderCalendar = () => {
                allElements.calendarContainer.innerHTML = '';
                const startOfWeek = currentDate.startOf('week');
                allElements.currentMonthYearEl.textContent = startOfWeek.format('MMMM YYYY');
                
                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dateStr = day.format('YYYY-MM-DD');
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day text-center p-2 md:p-3 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-1 ${dateStr === selectedDate ? 'active' : ''}`;
                    dayEl.dataset.date = dateStr;
                    const dayWorkouts = workouts[dateStr] || [];
                    const isCompleted = dayWorkouts.length > 0 && dayWorkouts.every(w => w.completed);
                    const isPlanned = dayWorkouts.length > 0;
                    
                    dayEl.innerHTML = `
                        <span class="text-xs md:text-sm uppercase font-semibold text-gray-400 ${dateStr === selectedDate ? 'text-white/80' : ''}">${day.format('ddd')}</span>
                        <span class="text-lg md:text-xl font-bold">${day.format('D')}</span>
                        <div class="w-1.5 h-1.5 rounded-full ${isCompleted ? 'bg-green-400' : isPlanned ? 'bg-purple-400' : 'bg-transparent'}"></div>
                    `;
                    dayEl.addEventListener('click', () => { 
                        selectedDate = dateStr; 
                        renderCalendar(); 
                        renderWorkouts(); 
                    });
                    allElements.calendarContainer.appendChild(dayEl);
                }
            };
            
            const renderWorkouts = () => {
                allElements.selectedDateDisplay.textContent = dayjs(selectedDate).format('dddd, MMMM D, YYYY');
                allElements.workoutList.innerHTML = '';
                const dayWorkouts = workouts[selectedDate] || [];

                if (dayWorkouts.length === 0) {
                    allElements.workoutList.innerHTML = `<div class="text-center py-8"><p class="text-gray-400">No workouts planned for this day.</p><p class="text-gray-500 text-sm">Add a workout or apply a template!</p></div>`;
                    return;
                }

                dayWorkouts.forEach(workout => {
                    const workoutEl = document.createElement('div');
                    workoutEl.className = `workout-item bg-white/5 p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 animate-fade-in`;
                    workoutEl.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-black/20 shrink-0">${ICONS[workout.type] || ICONS['Strength']}</div>
                            <div>
                                <h3 class="font-bold text-white text-lg">${workout.name}</h3>
                                <p class="text-sm text-gray-400">${workout.type} &bull; ${workout.duration} mins ${workout.completed ? `&bull; <span class="text-green-400 font-semibold">Completed</span>` : ''}</p>
                                ${workout.completed && workout.sets ? `<p class="text-xs text-gray-500">Logged: ${workout.sets} sets, ${workout.reps} reps, ${workout.weight} kg</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-1 self-end sm:self-center">
                            <button class="explain-btn p-2 rounded-full hover:bg-white/10" data-name="${workout.name}" title="Explain Exercise">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </button>
                            <button class="start-timer-btn p-2 rounded-full hover:bg-white/10 ${workout.completed ? 'hidden' : ''}" data-id="${workout.id}" title="Start Timer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </button>
                            <button class="log-btn p-2 rounded-full hover:bg-white/10 ${workout.completed ? 'hidden' : ''}" data-id="${workout.id}" title="Log Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                            </button>
                            <button class="edit-btn p-2 rounded-full hover:bg-white/10" data-id="${workout.id}" title="Edit Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="delete-btn p-2 rounded-full hover:bg-white/10" data-id="${workout.id}" title="Delete Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    allElements.workoutList.appendChild(workoutEl);
                });
                attachWorkoutEventListeners();
            };

            const renderProgress = () => {
                allElements.progressContainer.innerHTML = '';
                const startOfWeek = currentDate.startOf('week');
                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dateStr = day.format('YYYY-MM-DD');
                    const dayWorkouts = workouts[dateStr] || [];
                    const completed = dayWorkouts.length > 0 && dayWorkouts.every(w => w.completed);
                    const planned = dayWorkouts.length > 0;
                    
                    let barHeight = completed ? 'h-24' : planned ? 'h-16' : 'h-2';
                    let barColor = completed ? 'bg-green-500' : planned ? 'bg-purple-500/50' : 'bg-gray-700';
                    if (day.isSame(dayjs(), 'day')) barColor += ' pulsate';

                    const dayEl = document.createElement('div');
                    dayEl.className = 'flex flex-col items-center gap-2 flex-1';
                    dayEl.innerHTML = `<div class="w-full ${barHeight} ${barColor} rounded-t-md transition-all duration-500" title="${day.format('MMM D')}"></div><span class="text-xs font-bold text-gray-400">${day.format('ddd')}</span>`;
                    allElements.progressContainer.appendChild(dayEl);
                }
            };
            
            const renderTemplates = () => {
                allElements.templateList.innerHTML = '';
                WORKOUT_TEMPLATES.forEach(template => {
                    const templateEl = document.createElement('div');
                    templateEl.className = 'glass-card p-4 rounded-lg cursor-pointer hover:border-purple-400';
                    templateEl.dataset.templateName = template.name;
                    templateEl.innerHTML = `<h3 class="font-bold text-white text-lg">${template.name}</h3><p class="text-sm text-gray-400">${template.plan.map(p => p.type).join(', ')}</p>`;
                    templateEl.addEventListener('click', () => handleTemplateSelect(template.name));
                    allElements.templateList.appendChild(templateEl);
                });
            };

            // --- EVENT HANDLERS ---
            const attachWorkoutEventListeners = () => {
                document.querySelectorAll('.explain-btn').forEach(btn => btn.onclick = (e) => handleExplain(e.currentTarget.dataset.name));
                document.querySelectorAll('.start-timer-btn').forEach(btn => btn.onclick = (e) => startTimer(e.currentTarget.dataset.id));
                document.querySelectorAll('.log-btn').forEach(btn => btn.onclick = (e) => handleLog(e.currentTarget.dataset.id));
                document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = (e) => handleEdit(e.currentTarget.dataset.id));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = (e) => handleDelete(e.currentTarget.dataset.id));
            };

            const handleLog = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;

                const workoutIndex = workouts[selectedDate].findIndex(w => w.id === workoutId);
                if (workoutIndex === -1) return;
                
                // **FIX**: Show detailed log for 'Strength', otherwise just mark as complete.
                if (workout.type !== 'Strength') {
                    workouts[selectedDate][workoutIndex].completed = true;
                    saveAndRerender();
                    return;
                }
                
                allElements.logForm.innerHTML = `
                    <h3 class="font-semibold mb-4 text-white text-xl">Log: ${workout.name}</h3>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                       <div><label class="text-xs text-gray-400">Sets</label><input type="number" id="log-sets" placeholder="3" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-2 text-white focus:outline-none focus:ring-1 focus:ring-green-500" required></div>
                       <div><label class="text-xs text-gray-400">Reps</label><input type="number" id="log-reps" placeholder="10" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-2 text-white focus:outline-none focus:ring-1 focus:ring-green-500" required></div>
                       <div><label class="text-xs text-gray-400">Weight (kg)</label><input type="number" step="0.5" id="log-weight" placeholder="20" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-2 text-white focus:outline-none focus:ring-1 focus:ring-green-500" required></div>
                    </div>
                    <button type="submit" class="w-full btn-primary font-semibold py-3 px-3 rounded-lg">Log & Complete</button>`;
                
                allElements.logForm.onsubmit = (e) => {
                    e.preventDefault();
                    const sets = document.getElementById('log-sets').value;
                    const reps = document.getElementById('log-reps').value;
                    const weight = document.getElementById('log-weight').value;
                    
                    if (workoutIndex > -1) {
                        workouts[selectedDate][workoutIndex] = { ...workouts[selectedDate][workoutIndex], completed: true, sets, reps, weight };
                        closeModal(allElements.logModal);
                        saveAndRerender();
                    }
                };
                openModal(allElements.logModal);
            };

            const handleEdit = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;
                allElements.workoutModalTitle.textContent = "Edit Workout";
                allElements.workoutIdInput.value = workout.id;
                allElements.workoutNameInput.value = workout.name;
                allElements.workoutTypeInput.value = workout.type;
                allElements.workoutDurationInput.value = workout.duration;
                openModal(allElements.workoutModal);
            };

            const handleDelete = (workoutId) => {
                workouts[selectedDate] = workouts[selectedDate].filter(w => w.id !== workoutId);
                saveAndRerender();
            };

            const handleTemplateSelect = (templateName) => {
                const template = WORKOUT_TEMPLATES.find(t => t.name === templateName);
                const startOfWeek = currentDate.startOf('week');
                template.plan.forEach(item => {
                    const date = startOfWeek.add(item.d, 'day').format('YYYY-MM-DD');
                    if (!workouts[date]) workouts[date] = [];
                    workouts[date].push({ id: `workout-${Date.now()}-${Math.random()}`, name: item.n, type: item.type, duration: item.min, completed: false });
                });
                closeModal(allElements.templateModal);
                saveAndRerender();
            };

            // --- GEMINI API FUNCTIONS ---
            const callGemini = async (payload) => {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error('Invalid response structure from API.');
                    }
                } catch (error) {
                    console.error("Gemini API call error:", error);
                    return null;
                }
            };

            const handleExplain = async (workoutName) => {
                allElements.explanationTitle.textContent = workoutName;
                allElements.explanationContent.innerHTML = `<div class="flex items-center justify-center p-8"><svg class="spinner h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
                openModal(allElements.explanationModal);

                const prompt = `Provide a detailed, step-by-step guide for the exercise "${workoutName}". Structure the explanation into the following sections using markdown headings: 'Setup', 'Execution', and 'Pro Tips'.
- In the 'Execution' section, use a numbered list for the steps.
- Use markdown bolding for important keywords (e.g., **core engaged**, **neutral spine**).
- Where applicable, use LaTeX for numerical values, especially angles (e.g., bend your knees to a $90^\\circ$ angle).
Keep the language clear and concise for a fitness enthusiast.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                
                const explanation = await callGemini(payload);

                if (explanation) {
                    // A more robust markdown to HTML converter
                    let html = explanation
                        // Bolding
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        // Headings
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold text-white mt-4 mb-2">$1</h3>')
                        // Process entire list blocks at once
                        .replace(/^\s*(\d+\..+(?:\n\s*\d+\..+)*)/gm, (match) => {
                            const items = match.split('\n').map(line => 
                                line.replace(/^\s*\d+\.\s*(.*)/, '<li>$1</li>')
                            ).join('');
                            return `<ol class="list-decimal list-inside space-y-2">${items}</ol>`;
                        })
                        // Convert remaining newlines to <br> for paragraphs
                        .replace(/\n/g, '<br>');

                    allElements.explanationContent.innerHTML = html;
                    
                    // Re-render LaTeX after updating content
                    if (window.MathJax) {
                        window.MathJax.typeset();
                    }
                } else {
                    allElements.explanationContent.textContent = 'Sorry, I couldn\'t fetch the explanation. Please try again.';
                }
            };
            
            allElements.aiGeneratorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const errorEl = document.getElementById('ai-error-msg');
                errorEl.textContent = ''; // Clear previous errors

                allElements.aiSubmitText.textContent = "Generating...";
                allElements.aiSpinner.classList.remove('hidden');
                allElements.aiSubmitBtn.disabled = true;

                const goal = document.getElementById('ai-goal').value;
                const equipment = document.getElementById('ai-equipment').value || 'bodyweight only';
                const duration = document.getElementById('ai-duration').value;

                const prompt = `Generate a workout plan for a user with the goal: "${goal}". Equipment: "${equipment}". Total duration: around ${duration} minutes. Respond with ONLY a valid JSON array of objects. Each object needs "name" (string), "type" ("Strength", "Cardio", or "Flexibility"), and "duration" (number in minutes). Be efficient and generate a sensible number of exercises for the given duration. No extra text.`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "name": { "type": "STRING" },
                                    "type": { "type": "STRING", "enum": ["Strength", "Cardio", "Flexibility"] },
                                    "duration": { "type": "NUMBER" }
                                },
                                required: ["name", "type", "duration"]
                            }
                        }
                    }
                };

                const resultJson = await callGemini(payload);

                if (resultJson) {
                    try {
                        const newWorkouts = JSON.parse(resultJson);
                        if (!Array.isArray(newWorkouts)) throw new Error("Response is not an array.");

                        if (!workouts[selectedDate]) workouts[selectedDate] = [];
                        newWorkouts.forEach(w => {
                            if(w.name && w.type && w.duration) { // Basic validation
                                workouts[selectedDate].push({
                                    id: `workout-${Date.now()}-${Math.random()}`,
                                    name: w.name,
                                    type: w.type,
                                    duration: w.duration,
                                    completed: false
                                });
                            }
                        });
                        saveAndRerender();
                        closeModal(allElements.aiGeneratorModal);
                    } catch (err) {
                        console.error("Failed to parse AI response:", err);
                        errorEl.textContent = 'The AI returned an invalid format. Please try again.';
                    }
                } else {
                    errorEl.textContent = 'Could not generate workout. Please try again.';
                }

                allElements.aiSubmitText.textContent = "Generate Workout";
                allElements.aiSpinner.classList.add('hidden');
                allElements.aiSubmitBtn.disabled = false;
            });
            
            // --- TIMER LOGIC ---
            const startTimer = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;
                
                timeRemaining = workout.duration * 60;
                totalTime = timeRemaining;
                isPaused = false;
                allElements.timerWorkoutName.textContent = workout.name;
                allElements.playIcon.classList.add('hidden');
                allElements.pauseIcon.classList.remove('hidden');
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    if (!isPaused) {
                        timeRemaining--;
                        updateTimerDisplay();
                        if (timeRemaining <= 0) {
                            clearInterval(timerInterval);
                            // Auto-complete workout after timer finishes
                            const workoutIndex = workouts[selectedDate].findIndex(w => w.id === workoutId);
                            if (workoutIndex > -1) workouts[selectedDate][workoutIndex].completed = true;
                            saveAndRerender();
                            setTimeout(() => closeModal(allElements.timerModal), 1000); // Close after 1s
                        }
                    }
                }, 1000);
                openModal(allElements.timerModal);
            };

            const updateTimerDisplay = () => {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                allElements.timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                const progress = (totalTime - timeRemaining) / totalTime;
                allElements.timerProgressCircle.style.strokeDashoffset = 283 * (1 - progress);
            };

            const pauseResumeTimer = () => {
                isPaused = !isPaused;
                allElements.playIcon.classList.toggle('hidden', !isPaused);
                allElements.pauseIcon.classList.toggle('hidden', isPaused);
            };
            
            const stopTimer = () => {
                clearInterval(timerInterval);
                closeModal(allElements.timerModal);
            };

            // --- INITIALIZATION ---
            const init = () => {
                allElements.currentDateEl.textContent = dayjs().format('dddd, MMMM D');
                renderCalendar();
                renderWorkouts();
                renderProgress();
                renderTemplates();

                // General Event Listeners
                document.getElementById('prev-week').addEventListener('click', () => { currentDate = currentDate.subtract(1, 'week'); renderCalendar(); });
                document.getElementById('next-week').addEventListener('click', () => { currentDate = currentDate.add(1, 'week'); renderCalendar(); });
                document.getElementById('add-workout-btn').addEventListener('click', () => {
                    allElements.workoutModalTitle.textContent = "Add New Workout";
                    allElements.workoutForm.reset();
                    allElements.workoutIdInput.value = '';
                    openModal(allElements.workoutModal);
                });
                document.getElementById('ai-generate-btn').addEventListener('click', () => openModal(allElements.aiGeneratorModal));
                document.getElementById('workout-templates-card').addEventListener('click', () => openModal(allElements.templateModal));
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.fixed'))));
                document.querySelectorAll('.fixed').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }));

                allElements.workoutForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const workoutData = {
                        // **FIX**: Use a unique ID for new workouts. Template literals `` are needed.
                        id: allElements.workoutIdInput.value || `workout-${Date.now()}-${Math.random()}`,
                        name: allElements.workoutNameInput.value,
                        type: allElements.workoutTypeInput.value,
                        duration: allElements.workoutDurationInput.value,
                    };
                    if (!workouts[selectedDate]) workouts[selectedDate] = [];
                    const existingIndex = workouts[selectedDate].findIndex(w => w.id === workoutData.id);
                    if (existingIndex > -1) {
                        workouts[selectedDate][existingIndex] = { ...workouts[selectedDate][existingIndex], ...workoutData };
                    } else {
                        workouts[selectedDate].push({ ...workoutData, completed: false });
                    }
                    closeModal(allElements.workoutModal);
                    saveAndRerender();
                });

                allElements.pauseResumeBtn.addEventListener('click', pauseResumeTimer);
                document.getElementById('stop-timer-btn').addEventListener('click', stopTimer);

                setInterval(() => allElements.currentDateEl.textContent = dayjs().format('dddd, MMMM D'), 60000);
            };

            init();
        });
    </script>

</body>
</html>



