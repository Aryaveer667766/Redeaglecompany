<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Red Eagle - Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        :root { --theme-color: 79 70 229; /* Indigo */ }
        body { font-family: 'Inter', sans-serif; background: #000; color: #e5e7eb; }
        .main-bg { background-color: #0a0a0a; position: relative; overflow: hidden; }
        .aurora { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse 200% 100% at 90% -10%, rgba(192, 38, 211, 0.1), transparent), radial-gradient(ellipse 200% 100% at 10% 110%, rgba(var(--theme-color), 0.15), transparent); animation: aurora-anim 15s infinite linear; z-index: 0; }
        @keyframes aurora-anim { 0% { transform: rotate(0deg) scale(1.5); } 50% { transform: rotate(180deg) scale(2); } 100% { transform: rotate(360deg) scale(1.5); } }
        .glass-card { background: rgba(17, 17, 17, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .profit { color: #22c55e; } .loss { color: #ef4444; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); }
        #qr-reader { width: 100%; border-radius: 1rem; overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.2); }
        .mobile-nav { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; } .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; } .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .theme-bg { background-color: rgb(var(--theme-color)); } .theme-text { color: rgb(var(--theme-color)); } .theme-border-focus:focus { border-color: rgb(var(--theme-color)); } .theme-bg-hover:hover { background-color: rgba(var(--theme-color), 0.8) !important; }
        .pin-dot { width: 1rem; height: 1rem; border-radius: 50%; border: 2px solid #6b7280; transition: background-color 0.2s; } .pin-dot.filled { background-color: rgb(var(--theme-color)); border-color: rgb(var(--theme-color)); }
        .keypad-btn { background-color: rgba(255,255,255,0.05); transition: background-color 0.2s; } .keypad-btn:active { background-color: rgba(255,255,255,0.15); }
        .nav-active { color: rgb(var(--theme-color)); background-color: rgba(var(--theme-color), 0.1); border-radius: 0.5rem; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body class="text-gray-200">
    <!-- Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 modal-backdrop z-50 flex flex-col justify-center items-center p-4">
        <div class="text-center">
            <h1 id="lock-title" class="text-2xl font-bold text-white mb-2">Enter PIN</h1>
            <p id="lock-subtitle" class="text-gray-400 mb-6"></p>
            <div id="pin-dots" class="flex justify-center space-x-4 mb-8">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
        </div>
        <div id="keypad" class="grid grid-cols-3 gap-4 w-full max-w-xs"></div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden main-bg hidden">
        <div class="aurora"></div>
        <!-- Sidebar -->
        <aside class="w-20 bg-black flex-col items-center py-6 space-y-6 z-10 hidden md:flex">
             <div class="theme-text"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.64 3.42c.43-.23.96-.23 1.4 0l8 4.22a1 1 0 0 1 .55.88V15c0 .34-.17.65-.44.83l-8 5.22a1 1 0 0 1-1.1 0l-8-5.22A1 1 0 0 1 3 15V8.52a1 1 0 0 1 .55-.88zM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path></svg></div>
             <div id="desktop-nav" class="flex flex-col items-center space-y-4 text-gray-500">
                <a href="#dashboard" class="nav-link p-3" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></a>
                <a href="#markets" class="nav-link p-3" title="Markets"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></a>
                <a href="#portfolio" class="nav-link p-3" title="Portfolio"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 7V5a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2"></path><path d="M22 7H2"></path><path d="M14 11h-1"></path><path d="M17 11h-1"></path><path d="M20 11h-1"></path><path d="M14 15h-1"></path><path d="M17 15h-1"></path><path d="M20 15h-1"></path></svg></a>
                <a href="#settings" class="nav-link p-3" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="relative flex-1 p-4 md:p-6 overflow-y-auto pb-24 md:pb-6 custom-scrollbar">
             <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 id="user-greeting" class="text-2xl md:text-3xl font-bold text-white"></h1>
                    <p class="text-gray-400 text-sm md:text-base">Welcome to The Red Eagle.</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="notifications-btn" class="relative text-gray-400 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            <span id="notification-dot" class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full hidden"></span>
                        </button>
                        <div id="notifications-panel" class="hidden absolute right-0 mt-2 w-80 bg-gray-900 border border-gray-700 rounded-lg shadow-lg z-20">
                            <div class="p-3 border-b border-gray-700 font-bold flex justify-between items-center"><span>Notifications</span><button id="clear-notifications-btn" class="text-xs text-gray-400 hover:text-white">Clear All</button></div>
                            <div id="notifications-list" class="p-2 max-h-96 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>
                    <button id="pay-button" class="flex items-center space-x-2 theme-bg theme-bg-hover text-white font-semibold py-2 px-4 md:py-3 md:px-6 rounded-xl transition-transform duration-200 hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        <span class="hidden sm:inline">Pay</span>
                    </button>
                </div>
            </header>
            
            <div id="dashboard-view" class="page-view"></div>
            <div id="markets-view" class="page-view hidden"></div>
            <div id="portfolio-view" class="page-view hidden"></div>
            <div id="settings-view" class="page-view hidden"></div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <nav id="mobile-nav-bar" class="md:hidden fixed bottom-0 left-0 right-0 h-16 mobile-nav flex justify-around items-center z-20">
        <a href="#dashboard" class="nav-link p-3" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></a>
        <a href="#markets" class="nav-link p-3" title="Markets"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></a>
        <a href="#portfolio" class="nav-link p-3" title="Portfolio"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 7V5a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2"></path><path d="M22 7H2"></path><path d="M14 11h-1"></path><path d="M17 11h-1"></path><path d="M20 11h-1"></path><path d="M14 15h-1"></path><path d="M17 15h-1"></path><path d="M20 15h-1"></path></svg></a>
        <a href="#settings" class="nav-link p-3" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></a>
    </nav>
    
    <div id="modal-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- DATA & STATE MANAGEMENT ---
    const DB_KEY = 'redEagleData';
    let state = {};
    let charts = {};
    let soundEnabled = false;
    let intervals = {};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const synth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();

    const defaultData = {
        user: { name: 'Aryaveer', pin: null, settings: { theme: '79 70 229', sound: true } },
        finances: { balance: 800000, transactions: [], portfolio: {}, recentPayees: [], },
        market: {
            stocks: [
                { ticker: 'APXD', name: 'Apex Dynamics', price: 150.75, trend: Array.from({length:30}, ()=>150+(Math.random()-0.5)*10) },
                { ticker: 'NOVE', name: 'Nova Energy', price: 280.50, trend: Array.from({length:30}, ()=>280+(Math.random()-0.5)*20) },
                { ticker: 'QNTM', name: 'Quantum Solutions', price: 450.25, trend: Array.from({length:30}, ()=>450+(Math.random()-0.5)*30) },
                { ticker: 'FLXR', name: 'Flexor Corp', price: 88.90, trend: Array.from({length:30}, ()=>88+(Math.random()-0.5)*5) },
                { ticker: 'TRRA', name: 'Terra Guild', price: 320.00, trend: Array.from({length:30}, ()=>320+(Math.random()-0.5)*15) },
            ]
        },
        notifications: [],
    };

    function loadData() {
        const savedData = localStorage.getItem(DB_KEY);
        if (savedData) {
            state = JSON.parse(savedData);
            state.user = { ...defaultData.user, ...state.user };
            state.finances = { ...defaultData.finances, ...state.finances };
            // Don't overwrite stock prices from default, but ensure structure
            state.market = state.market || defaultData.market;
            state.notifications = state.notifications || [];
        } else {
            state = JSON.parse(JSON.stringify(defaultData)); // Deep copy
        }
    }

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(state));
    }
    
    const T = { // HTML Templates
        dashboard: `
            <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
                <div class="xl:col-span-3 flex flex-col gap-6">
                    <div class="grid grid-cols-2 gap-4 md:gap-6">
                        <div class="glass-card col-span-2 p-4 md:p-6 rounded-2xl">
                            <h3 class="text-gray-400 text-sm font-medium">Available Balance</h3>
                            <p id="balance" class="text-3xl md:text-4xl font-extrabold text-white mt-2"></p>
                        </div>
                        <div class="glass-card p-4 md:p-6 rounded-2xl">
                            <h3 class="text-gray-400 text-sm font-medium">Today's P/L</h3>
                            <div id="pnl" class="flex items-center mt-2"><p class="text-xl md:text-2xl font-extrabold"></p></div>
                        </div>
                        <div class="glass-card p-4 md:p-6 rounded-2xl">
                             <h3 class="text-gray-400 text-sm font-medium">Portfolio Value</h3>
                             <p id="portfolio-value" class="text-xl md:text-2xl font-extrabold text-white mt-2"></p>
                        </div>
                    </div>
                    <div class="glass-card p-4 md:p-6 rounded-2xl h-[40vh] md:h-[50vh] xl:h-[calc(100%-12rem)]">
                        <div class="chart-container"><canvas id="balanceChart"></canvas></div>
                    </div>
                </div>
                <div class="xl:col-span-2 flex flex-col gap-6">
                    <div class="glass-card p-4 md:p-6 rounded-2xl h-[40vh] md:h-auto xl:h-1/2 flex flex-col">
                        <h3 class="text-lg font-bold text-white mb-4">Distribution</h3>
                        <div class="chart-container flex-1"><canvas id="portfolioChart"></canvas></div>
                    </div>
                    <div class="glass-card p-4 md:p-6 rounded-2xl h-[40vh] md:h-auto xl:h-1/2 flex flex-col">
                        <h3 class="text-lg font-bold text-white mb-4">Recent Transactions</h3>
                        <div id="transaction-list" class="flex-1 overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                </div>
            </div>`,
        markets: `
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-6">Markets</h1>
            <div id="stock-list" class="space-y-4"></div>`,
        portfolio: `
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-6">My Portfolio</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-gray-400 text-sm font-medium">Total Investment</h3>
                    <p id="total-investment" class="text-3xl font-extrabold text-white mt-2"></p>
                </div>
                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-gray-400 text-sm font-medium">Overall P/L</h3>
                    <div id="overall-pnl" class="flex items-center mt-2"><p class="text-3xl font-extrabold"></p></div>
                </div>
            </div>
            <div id="portfolio-list" class="glass-card rounded-2xl p-4"></div>`,
        settings: () => `
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-6">Settings</h1>
            <div class="glass-card rounded-2xl p-6 space-y-6">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-400">Display Name</label>
                    <input type="text" id="username-input" class="mt-1 block w-full bg-gray-900/50 rounded-md border-gray-700 shadow-sm theme-border-focus focus:ring-0 sm:text-sm p-3" value="${state.user.name}">
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-400">Theme Color</label>
                     <div id="theme-selector" class="mt-2 flex space-x-3"></div>
                </div>
                <div>
                    <label class="flex items-center justify-between">
                         <span class="text-sm font-medium text-gray-400">Sound Effects</span>
                         <div class="relative inline-flex items-center cursor-pointer">
                           <input type="checkbox" id="sound-toggle" class="sr-only peer" ${state.user.settings.sound ? 'checked' : ''}>
                           <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-offset-2 peer-focus:ring-offset-gray-800 peer-focus:ring-white peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                         </div>
                    </label>
                </div>
                 <button id="save-settings-btn" class="w-full theme-bg theme-bg-hover text-white font-bold py-3 px-5 rounded-lg">Save Changes</button>
            </div>`,
        paymentModal: `
             <div id="payment-modal" class="fixed inset-0 modal-backdrop flex justify-center items-center z-50 hidden">
                <div id="modal-content" class="glass-card p-6 md:p-8 rounded-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
                    <!-- Views will be injected here -->
                </div>
             </div>`,
        tradeModal: `
            <div id="trade-modal" class="fixed inset-0 modal-backdrop flex justify-center items-center z-50 hidden">
                <div id="trade-modal-content" class="glass-card p-6 md:p-8 rounded-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
                    <!-- Trade modal content -->
                </div>
            </div>`,
    };
    
    // --- PIN & LOCK SCREEN ---
    let pinEntry = '';
    let pinToConfirm = '';
    let isCreatingPin = false;

    function setupPinCreation() {
        isCreatingPin = true;
        $('#lock-title').textContent = 'Create a PIN';
        $('#lock-subtitle').textContent = 'You\'ll use this to log in.';
        resetPinDots();
    }

    function setupPinLogin() {
        isCreatingPin = false;
        $('#lock-title').textContent = 'Enter PIN';
        $('#lock-subtitle').textContent = `Welcome back, ${state.user.name}`;
        resetPinDots();
    }

    function resetPinDots() {
        pinEntry = '';
        $$('#pin-dots .pin-dot').forEach(dot => dot.classList.remove('filled'));
    }

    function handlePinEntry(digit) {
        if (pinEntry.length >= 4) return;
        pinEntry += digit;
        updatePinDots();

        if (pinEntry.length === 4) {
            if (isCreatingPin) {
                if (!pinToConfirm) {
                    pinToConfirm = pinEntry;
                    $('#lock-title').textContent = 'Confirm Your PIN';
                    $('#lock-subtitle').textContent = '';
                    setTimeout(resetPinDots, 300);
                } else {
                    if (pinEntry === pinToConfirm) {
                        state.user.pin = pinEntry;
                        saveData();
                        initializeApp();
                    } else {
                        $('#lock-title').textContent = 'PINs did not match';
                        $('#lock-subtitle').textContent = 'Please try again.';
                        $('#lock-screen').classList.add('animate-shake');
                        pinToConfirm = '';
                        setTimeout(() => {
                            $('#lock-screen').classList.remove('animate-shake');
                            setupPinCreation();
                        }, 500);
                    }
                }
            } else {
                if (pinEntry === state.user.pin) {
                    initializeApp();
                } else {
                    $('#lock-subtitle').textContent = 'Incorrect PIN. Try again.';
                    $('#lock-screen').classList.add('animate-shake');
                    setTimeout(() => {
                        resetPinDots();
                        $('#lock-screen').classList.remove('animate-shake');
                    }, 500);
                }
            }
        }
    }

    function updatePinDots() {
        $$('#pin-dots .pin-dot').forEach((dot, index) => {
            dot.classList.toggle('filled', index < pinEntry.length);
        });
    }
    
    function setupKeypad() {
        const keypad = $('#keypad');
        const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, '⌫'];
        keypad.innerHTML = keys.map(key => {
            if (key === '') return '<div></div>';
            return `<button class="keypad-btn text-2xl font-bold rounded-full h-20 w-20 flex justify-center items-center">${key}</button>`;
        }).join('');
        
        $$('.keypad-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.textContent;
                if (key === '⌫') {
                    pinEntry = pinEntry.slice(0, -1);
                    updatePinDots();
                } else {
                    handlePinEntry(key);
                }
            });
        });
    }
    
    function initializeApp() {
        $('#app-container').classList.remove('hidden');
        $('#lock-screen').classList.add('hidden');
        renderApp();
    }
    
    function renderApp() {
        // Render shell
        $('#dashboard-view').innerHTML = T.dashboard;
        $('#markets-view').innerHTML = T.markets;
        $('#portfolio-view').innerHTML = T.portfolio;
        $('#settings-view').innerHTML = T.settings();
        $('#modal-container').innerHTML = T.paymentModal + T.tradeModal;

        // Initial render of dynamic content
        updateTheme();
        updateGreeting();
        handleRouting();
        
        // Setup listeners
        setupNavListeners();
        setupPaymentModalListeners();
        setupNotificationsListeners();
        setupSettingsListeners();
        setupTradeModalListeners();

        // Start simulations
        startMarketSimulation();
    }

    function updateTheme() { 
        document.documentElement.style.setProperty('--theme-color', state.user.settings.theme); 
    }
    function updateGreeting() { $('#user-greeting').textContent = `Hi, ${state.user.name}`; }

    // --- NAVIGATION & ROUTING ---
    function setupNavListeners() {
        $$('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href');
                location.hash = targetId;
            });
        });
        window.addEventListener('hashchange', handleRouting);
    }

    function handleRouting() {
        const hash = location.hash || '#dashboard';
        $$('.page-view').forEach(view => view.classList.add('hidden'));
        $(`${hash}-view`).classList.remove('hidden');
        
        $$('.nav-link').forEach(l => l.classList.remove('nav-active'));
        $$(`a[href="${hash}"]`).forEach(l => l.classList.add('nav-active'));

        switch(hash) {
            case '#dashboard': renderDashboardContent(); break;
            case '#markets': renderMarketsContent(); break;
            case '#portfolio': renderPortfolioContent(); break;
            case '#settings': renderSettingsContent(); break;
        }
    }

    // --- MAIN RENDER FUNCTIONS ---
    function renderDashboardContent() {
        $('#balance').textContent = `₹${state.finances.balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        const portfolioValue = calculatePortfolioValue();
        $('#portfolio-value').textContent = `₹${portfolioValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        // Today's P/L is more complex now, requires tracking initial daily prices. We'll simplify for now.
        $('#pnl p').textContent = '₹0.00';
        $('#pnl').classList.remove('profit', 'loss');

        renderTransactions();
        renderDashboardCharts(portfolioValue);
    }

    function renderMarketsContent() {
        // Market render logic
    }
    function renderPortfolioContent() {
       // Portfolio render logic
    }
    function renderSettingsContent() {
       // Settings render logic
    }

    // --- CHARTS ---
    function renderDashboardCharts(portfolioValue) {
        // Balance Chart
        const balanceCtx = $('#balanceChart')?.getContext('2d');
        if (balanceCtx) {
            if (charts.balance) charts.balance.destroy();
            const gradient = balanceCtx.createLinearGradient(0, 0, 0, balanceCtx.canvas.clientHeight);
            gradient.addColorStop(0, `rgba(${state.user.settings.theme}, 0.5)`);
            gradient.addColorStop(1, `rgba(${state.user.settings.theme}, 0)`);
            charts.balance = new Chart(balanceCtx, {
                type: 'line', data: { labels: Array(30).fill(''), datasets: [{ label: 'Balance', data: state.market.stocks[0].trend, borderColor: `rgb(${state.user.settings.theme})`, backgroundColor: gradient, borderWidth: 3, pointRadius: 0, tension: 0.4, fill: true, }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { display: false }, x: { display: false } } }
            });
        }
        // Portfolio Doughnut Chart
        const portfolioCtx = $('#portfolioChart')?.getContext('2d');
        if(portfolioCtx) {
             if (charts.portfolio) charts.portfolio.destroy();
             const portfolioData = {
                 labels: ['Cash', ...Object.keys(state.finances.portfolio)],
                 values: [state.finances.balance, ...Object.values(state.finances.portfolio).map(p => p.shares * findStock(Object.keys(state.finances.portfolio)[Object.values(state.finances.portfolio).indexOf(p)]).price)]
             };
             charts.portfolio = new Chart(portfolioCtx, {
                type: 'doughnut', data: { labels: portfolioData.labels, datasets: [{ data: portfolioData.values, backgroundColor: ['#4B5563', '#4F46E5', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'], borderColor: '#111111', borderWidth: 4, }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', padding: 20, font: {size: 14} } } } }
             });
        }
    }

    // --- SIMULATIONS ---
    function startMarketSimulation(){
        intervals.market = setInterval(() => {
            let changed = false;
            state.market.stocks.forEach(stock => {
                const changePercent = (Math.random() - 0.48) * 0.05; // Slightly bullish
                if (Math.abs(changePercent) > 0.001) changed = true;
                const changeAmount = stock.price * changePercent;
                stock.price += changeAmount;
                stock.price = Math.max(10, stock.price);
                stock.trend.shift();
                stock.trend.push(stock.price);
            });
            if (changed) {
                if (location.hash === '#markets' || location.hash === '') renderMarketsContent();
                if (location.hash === '#portfolio') renderPortfolioContent();
                renderDashboardContent();
                saveData();
            }
        }, 2000);
    }

    // --- HELPERS ---
    function calculatePortfolioValue() {
        return Object.entries(state.finances.portfolio).reduce((total, [ticker, holding]) => {
            const stock = findStock(ticker);
            return total + (holding.shares * (stock ? stock.price : 0));
        }, 0);
    }
    function findStock(ticker) { return state.market.stocks.find(s => s.ticker === ticker); }
    function renderTransactions() {
        const listEl = $('#transaction-list');
        if (!listEl) return;
        if (state.finances.transactions.length === 0) {
            listEl.innerHTML = '<p class="text-gray-400 text-center py-4">No transactions yet.</p>';
            return;
        }
        listEl.innerHTML = state.finances.transactions.map(tx => `
            <div class="flex justify-between items-center py-2 border-b border-gray-800">
                <div>
                    <p class="font-semibold text-white">${tx.description}</p>
                    <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleString()}</p>
                </div>
                <p class="font-bold ${tx.type === 'credit' ? 'profit' : 'loss'}">${tx.type === 'credit' ? '+' : '-'} ₹${tx.amount.toLocaleString('en-IN')}</p>
            </div>
        `).join('');
    }
    // ... Stubs for other functions that will be fully implemented later ...
    function setupPaymentModalListeners() {}
    function setupTradeModalListeners() {}
    function setupNotificationsListeners() {}
    function setupSettingsListeners() {}
    
    // --- INIT ---
    loadData();
    if (!state.user.pin) {
        setupPinCreation();
    } else {
        setupPinLogin();
    }
    setupKeypad();
});
    </script>
</body>
</html>

