<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Planner Analyst Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-darkest: #0c0a09; --bg-dark: #18181b; --border-color: #27272a;
            --text-light: #f3f4f6; --text-muted: #a1a1aa; --primary: #3b82f6;
            --primary-light: #60a5fa; --gold: #f59e0b;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-darkest); color: var(--text-light); }
        main { height: calc(100vh - 120px); overflow-y: auto; }
        .card { background-color: var(--bg-dark); border: 1px solid var(--border-color); }
        .btn-primary { background-image: linear-gradient(to right, var(--primary), var(--primary-light)); color: white; transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.4); }
        .input-field, .textarea-field, .select-field { background-color: var(--border-color); border: 1px solid #3f3f46; color: white; }
        .input-field:focus, .textarea-field:focus, .select-field:focus { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); outline: none; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out forwards; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: var(--bg-dark); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); transition: color 0.2s; flex-grow: 1; padding: 4px 0; font-size: 0.8rem; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 0.9rem; }
        .nav-btn span { font-size: 0.6rem; margin-top: 3px; }

        .xp-bar-bg { background-color: var(--border-color); }
        .xp-bar-fg { background-image: linear-gradient(to right, #16a34a, #4ade80); transition: width 0.5s ease-in-out; }

        .badge { display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: #27272a; }
        .badge.earned { border-color: var(--gold); background-image: linear-gradient(to right, #332c1c, #4b3e21); color: #fef08a; }
        .badge.earned i { color: var(--gold); }
        
        .flashcard-container { perspective: 1000px; cursor: pointer; }
        .flashcard { width: 100%; height: 200px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 1rem; text-align: center; border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .flashcard-front { background-color: #27272a; }
        .flashcard-back { background-color: #3b82f6; transform: rotateY(180deg); }

        .timer-container:fullscreen { background-color: var(--bg-darkest); display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .timer-container:fullscreen .timer-circle { width: 300px; height: 300px; }
        .timer-container:fullscreen .timer-display { font-size: 6rem; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 500; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .timer-circle { position: relative; width: 150px; height: 150px; border-radius: 50%; display: grid; place-items: center; background: conic-gradient(var(--primary) 0deg, var(--border-color) 0deg); }
        .timer-circle::before { content: ''; position: absolute; width: 85%; height: 85%; background: var(--bg-dark); border-radius: 50%; }
        .timer-display { position: relative; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">

    <!-- Setup Screen -->
    <div id="setup-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto card rounded-xl p-8 shadow-2xl">
            <h1 class="text-4xl font-extrabold text-center text-white mb-2">Welcome, Future IITian!</h1>
            <p class="text-center text-gray-400 mb-8">Let's architect your journey to JEE 2027.</p>
            <div class="mb-6"><label for="user-name" class="block text-sm font-medium text-gray-300 mb-2">What is your name, champion?</label><input type="text" id="user-name" placeholder="Enter your name" class="w-full input-field rounded-lg p-3"></div>
            <h2 class="text-2xl font-bold text-white mb-4">Initial Syllabus Status</h2>
            <div id="setup-syllabus-container" class="space-y-6 max-h-[40vh] overflow-y-auto pr-4"></div>
            <button id="save-setup-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-8 text-lg"><i class="fas fa-rocket mr-2"></i>Launch My Plan</button>
        </div>
    </div>

    <!-- Main App Structure -->
    <div id="app-container" class="hidden">
        <header class="p-4 flex justify-between items-center bg-darkest h-[60px]">
            <h1 id="welcome-message" class="text-xl font-bold text-white"></h1>
            <button id="reset-btn" class="btn-secondary text-xs font-semibold py-2 px-3 rounded-lg"><i class="fas fa-undo mr-1"></i>Reset</button>
        </header>
        
        <main>
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content active p-4 space-y-6">
                <div class="card rounded-xl p-4">
                    <div id="xp-level-display" class="text-center"></div>
                    <div class="w-full xp-bar-bg rounded-full h-3 mt-2"><div id="xp-bar" class="xp-bar-fg h-3 rounded-full"></div></div>
                </div>
                <p id="motivational-quote" class="text-center text-lg text-blue-300"></p>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Syllabus Progress</h2><div id="smart-feedback" class="text-sm bg-gray-800 border border-blue-500/30 text-blue-200 p-3 rounded-lg mb-4"></div><div id="progress-bars" class="space-y-4"></div></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Today's Main Goal</h2><div id="daily-goal-container"></div></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Strategic Goals</h2><div id="long-term-goals-container" class="space-y-4"></div></div>
            </div>

            <!-- Tasks & Timer Tab -->
            <div id="tasks-tab" class="tab-content p-4 space-y-6">
                <div class="card rounded-xl p-6 timer-container"><h2 class="text-xl font-bold text-white mb-4">Pomodoro Timer</h2><div class="flex flex-col items-center"><div class="timer-circle mb-4"><div id="timer-display" class="timer-display text-4xl font-bold">25:00</div></div><div class="flex gap-3 items-center"><button id="timer-start-pause" class="btn-primary font-bold py-2 px-5 rounded-lg"><i class="fas fa-play"></i></button><button id="timer-reset" class="btn-secondary font-bold py-2 px-5 rounded-lg"><i class="fas fa-sync"></i></button><button id="timer-fullscreen" class="text-gray-400 hover:text-white"><i class="fas fa-expand"></i></button></div><div class="mt-4 flex items-center space-x-2"><input type="checkbox" id="wake-lock-toggle" class="form-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600"><label for="wake-lock-toggle" class="text-sm text-gray-400">Keep Screen On</label></div></div></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Tasks for Today</h2><div class="flex gap-2 mb-4"><input type="text" id="new-task-input" placeholder="Add a new task" class="flex-grow input-field rounded-lg p-2"><button id="add-task-btn" class="btn-primary font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus"></i></button></div><ul id="task-list" class="space-y-2 max-h-64 overflow-y-auto"></ul></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Quick Notes</h2><textarea id="quick-notes" class="textarea-field w-full h-32 rounded-lg p-2" placeholder="Jot down a quick thought or formula..."></textarea></div>
            </div>

            <!-- Syllabus Tab -->
            <div id="syllabus-tab" class="tab-content p-4 space-y-6">
                 <div class="card rounded-xl p-6"><h2 class="text-xl font-bold text-white mb-4">Update Syllabus Completion</h2><div id="full-syllabus-container" class="space-y-6"></div></div>
            </div>

            <!-- Tests Tab -->
            <div id="tests-tab" class="tab-content p-4 space-y-6">
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold mb-4">Log New Mock Test</h2><div class="space-y-3"><input id="mock-test-name" type="text" placeholder="Test Name (e.g., Allen FT-3)" class="input-field w-full rounded p-2"><div class="grid grid-cols-3 gap-3"><div><h3 class="text-center font-bold mb-1">Physics</h3><input type="number" placeholder="Correct" class="mock-input input-field w-full rounded p-1 text-sm" data-subject="phy" data-type="correct"><input type="number" placeholder="Incorrect" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="phy" data-type="incorrect"><input type="number" placeholder="Unattempted" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="phy" data-type="unattempted"></div><div><h3 class="text-center font-bold mb-1">Chemistry</h3><input type="number" placeholder="Correct" class="mock-input input-field w-full rounded p-1 text-sm" data-subject="chem" data-type="correct"><input type="number" placeholder="Incorrect" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="chem" data-type="incorrect"><input type="number" placeholder="Unattempted" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="chem" data-type="unattempted"></div><div><h3 class="text-center font-bold mb-1">Maths</h3><input type="number" placeholder="Correct" class="mock-input input-field w-full rounded p-1 text-sm" data-subject="math" data-type="correct"><input type="number" placeholder="Incorrect" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="math" data-type="incorrect"><input type="number" placeholder="Unattempted" class="mock-input input-field w-full rounded p-1 mt-1 text-sm" data-subject="math" data-type="unattempted"></div></div><button id="save-mock-test-btn" class="btn-primary w-full p-2 rounded mt-2">Save Test & Log Mistakes (+100 XP)</button></div></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold mb-4">Past Tests</h2><div id="mock-tests-list" class="space-y-2"></div></div>
            </div>
            
            <!-- Formulas Tab -->
            <div id="formulas-tab" class="tab-content p-4 space-y-6">
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold mb-4">Add New Formula</h2><div class="space-y-3"><select id="formula-subject" class="select-field w-full rounded p-2"></select><select id="formula-chapter" class="select-field w-full rounded p-2"></select><textarea id="formula-text" placeholder="Enter Formula (e.g., F = ma)" class="textarea-field w-full h-24 p-2 rounded"></textarea><textarea id="formula-notes" placeholder="Notes (e.g., only for constant mass)" class="textarea-field w-full h-16 p-2 rounded"></textarea><button id="save-formula-btn" class="btn-primary w-full p-2 rounded">Save Formula</button></div></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold mb-4">Formula Vault</h2><input type="text" id="formula-search" placeholder="Search formulas..." class="input-field w-full rounded p-2 mb-4"><div id="formula-list" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
            </div>

            <!-- Flashcards Tab -->
            <div id="flashcards-tab" class="tab-content p-4 space-y-6">
                <div id="flashcard-review-container" class="hidden">
                    <div class="flashcard-container"><div id="flashcard" class="flashcard"><div class="flashcard-face flashcard-front"><p id="flashcard-front-text"></p></div><div class="flashcard-face flashcard-back"><p id="flashcard-back-text"></p></div></div></div>
                    <div id="flashcard-controls" class="hidden grid grid-cols-3 gap-2 mt-2">
                        <button data-ease="hard" class="bg-red-500 text-white p-2 rounded">Hard</button>
                        <button data-ease="good" class="bg-yellow-500 text-white p-2 rounded">Good</button>
                        <button data-ease="easy" class="bg-green-500 text-white p-2 rounded">Easy</button>
                    </div>
                </div>
                <div id="flashcard-no-review-message"></div>
                <div class="card rounded-xl p-6"><h2 class="text-xl font-bold mb-4">Create New Flashcard</h2><div class="space-y-3"><textarea id="new-flashcard-front" placeholder="Front (Question/Concept)" class="textarea-field w-full h-20 p-2 rounded"></textarea><textarea id="new-flashcard-back" placeholder="Back (Answer/Formula)" class="textarea-field w-full h-20 p-2 rounded"></textarea><button id="save-flashcard-btn" class="btn-primary w-full p-2 rounded">Create Card</button></div></div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content p-4 space-y-6">
                <div class="card rounded-xl p-6"><h3 class="text-xl font-bold text-blue-400 mb-3">Study Streak</h3><p class="text-5xl font-extrabold text-white"><span id="streak-days">0</span> Days <i class="fas fa-fire text-orange-400"></i></p></div>
                <div class="card rounded-xl p-6"><h3 class="text-xl font-bold text-blue-400 mb-3">Mock Test Performance</h3><canvas id="mock-test-chart"></canvas></div>
                <div class="card rounded-xl p-6"><h3 class="text-xl font-bold text-blue-400 mb-3">Mistake Analysis</h3><canvas id="mistake-chart"></canvas></div>
                <div class="card rounded-xl p-6"><h3 class="text-xl font-bold text-blue-400 mb-3">Smart Revision</h3><p class="text-gray-400 mb-4 text-sm">Priority chapters based on age & mock test mistakes.</p><ul id="revision-list" class="space-y-2"></ul></div>
                <div class="card rounded-xl p-6"><h3 class="text-xl font-bold text-blue-400 mb-3">Achievements</h3><div id="achievements-display" class="flex flex-wrap"></div></div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-tab="home-tab"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-tab="tasks-tab"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-btn" data-tab="syllabus-tab"><i class="fas fa-book-open"></i><span>Syllabus</span></button>
            <button class="nav-btn" data-tab="tests-tab"><i class="fas fa-file-alt"></i><span>Tests</span></button>
            <button class="nav-btn" data-tab="formulas-tab"><i class="fas fa-square-root-alt"></i><span>Formulas</span></button>
            <button class="nav-btn" data-tab="flashcards-tab"><i class="fas fa-layer-group"></i><span>Cards</span></button>
            <button class="nav-btn" data-tab="analytics-tab"><i class="fas fa-chart-line"></i><span>Stats</span></button>
        </nav>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content card rounded-xl p-8 w-full max-w-md"><h2 id="confirm-title" class="text-2xl font-bold text-white mb-4"></h2><p id="confirm-message" class="text-gray-300 mb-6"></p><div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-5 rounded-lg">Cancel</button><button id="confirm-ok-btn"></button></div></div></div>
    <div id="mistake-log-modal" class="modal-backdrop"><div class="modal-content card rounded-xl p-6 w-full max-w-lg"><h2 class="text-2xl font-bold text-white mb-4">Log Mistakes for <span id="mistake-log-test-name"></span></h2><div class="space-y-3"><select id="mistake-chapter" class="select-field w-full rounded p-2"></select><select id="mistake-reason" class="select-field w-full rounded p-2"><option value="Conceptual Gap">Conceptual Gap</option><option value="Silly Mistake">Silly Mistake</option><option value="Time Pressure">Time Pressure</option><option value="Calculation Error">Calculation Error</option></select><button id="save-mistake-btn" class="btn-primary w-full p-2 rounded">Add Mistake</button></div><hr class="my-4 border-gray-700"><h3 class="text-lg font-bold mb-2">Logged Mistakes</h3><div id="mistake-list" class="space-y-1 max-h-48 overflow-y-auto"></div><button id="finish-mistake-log-btn" class="bg-gray-600 hover:bg-gray-700 w-full p-2 rounded mt-4">Done</button></div></div>
    <div id="pyq-modal" class="modal-backdrop"><div class="modal-content card rounded-xl p-6 w-full max-w-md"><h2 class="text-2xl font-bold text-white mb-4">PYQ Tracker: <span id="pyq-chapter-name"></span></h2><div id="pyq-year-list" class="grid grid-cols-3 gap-2"></div><button id="save-pyq-btn" class="btn-primary w-full p-2 rounded mt-4">Save</button></div></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const syllabusData = {
        Physics: ["Physics and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power", "Rotational Motion", "Gravitation", "Properties of Solids and Liquids", "Thermodynamics", "Kinetic Theory of Gases", "Oscillations and Waves", "Electrostatics", "Current Electricity", "Magnetic Effects of Current and Magnetism", "Electromagnetic Induction and Alternating Currents", "Electromagnetic Waves", "Optics", "Dual Nature of Matter and Radiation", "Atoms and Nuclei", "Electronic Devices", "Communication Systems"],
        Chemistry: ["Some Basic Concepts in Chemistry", "States of Matter", "Atomic Structure", "Chemical Bonding and Molecular Structure", "Chemical Thermodynamics", "Solutions", "Equilibrium", "Redox Reactions and Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Classification of Elements and Periodicity in Properties", "General Principles and Processes of Isolation of Metals", "Hydrogen", "s-Block Elements", "p-Block Elements (Group 13 to 18)", "d- and f- Block Elements", "Co-ordination Compounds", "Environmental Chemistry", "Purification and Characterisation of Organic Compounds", "Some Basic Principles of Organic Chemistry", "Hydrocarbons", "Organic Compounds Containing Halogens", "Organic Compounds Containing Oxygen", "Organic Compounds Containing Nitrogen", "Polymers", "Biomolecules", "Chemistry in Everyday Life"],
        Mathematics: ["Sets, Relations and Functions", "Complex Numbers and Quadratic Equations", "Matrices and Determinants", "Permutations and Combinations", "Mathematical Induction", "Binomial Theorem and its Simple Applications", "Sequences and Series", "Limit, Continuity and Differentiability", "Integral Calculus", "Differential Equations", "Co-ordinate Geometry", "Three Dimensional Geometry", "Vector Algebra", "Statistics and Probability", "Trigonometry", "Mathematical Reasoning"]
    };
    const motivationalQuotes = ["Believe you can and you're halfway there.", "The secret to get ahead is getting started.", "Success is not final, failure is not fatal: it is the courage to continue that counts.", "Don't watch the clock; do what it does. Keep going.", "The grind never stops. Your future self is watching."];
    
    const XP_VALUES = { TASK: 5, GOAL: 20, CHAPTER: 50, MOCK_TEST: 100 };
    const LEVELS = [
        { name: "JEE Aspirant", xp: 0 }, { name: "Syllabus Starter", xp: 500 }, { name: "Concept Builder", xp: 1500 },
        { name: "Problem Solver", xp: 3000 }, { name: "Rank Chaser", xp: 5000 }, { name: "Mock Test Ninja", xp: 7500 },
        { name: "Revision Pro", xp: 10000 }, { name: "Future IITian", xp: 15000 }
    ];
    const ACHIEVEMENTS = {
        STREAK_5: { name: "On Fire!", desc: "Maintain a 5-day study streak.", icon: "fa-fire" },
        STREAK_10: { name: "Unstoppable", desc: "Maintain a 10-day study streak.", icon: "fa-meteor" },
        FIRST_GOAL: { name: "Goal Setter", desc: "Complete your first daily goal.", icon: "fa-bullseye" },
        FIRST_CHAPTER: { name: "Chapter One", desc: "Complete your first chapter.", icon: "fa-book-open" },
        FIRST_MOCK: { name: "Test Taker", desc: "Log your first mock test.", icon: "fa-file-alt" },
        PHYSICS_25: { name: "Physicist", desc: "Complete 25% of Physics syllabus.", icon: "fa-atom" },
        CHEMISTRY_25: { name: "Chemist", desc: "Complete 25% of Chemistry syllabus.", icon: "fa-flask" },
        MATHS_25: { name: "Mathematician", desc: "Complete 25% of Maths syllabus.", icon: "fa-calculator" },
        SCORE_150: { name: "150+ Club", desc: "Score 150 or more in a mock test.", icon: "fa-trophy" },
    };


    const app = {
        timerInterval: null, timerState: 'stopped', timerMode: 'focus', secondsLeft: 25 * 60,
        mockTestChart: null, mistakeChart: null, currentFlashcardIndex: -1, wakeLock: null,
        
        init() {
            this.dom = this.getCachedDOMElements();
            this.renderSyllabusChecklist(this.dom.setupSyllabusContainer);
            this.renderSyllabusChecklist(this.dom.fullSyllabusContainer, true);
            this.populateFormulaInputs();
            
            const user = this.getData('user');
            if (user && user.name) this.showApp();
            else this.showSetup();
            
            this.addEventListeners();
            this.updateTimerDisplay();
        },

        getCachedDOMElements() {
            const ids = [
                'setup-screen', 'app-container', 'user-name', 'setup-syllabus-container', 'save-setup-btn', 
                'welcome-message', 'reset-btn', 
                'home-tab', 'xp-level-display', 'xp-bar', 'motivational-quote', 'smart-feedback', 'progress-bars', 'daily-goal-container', 'long-term-goals-container', 
                'tasks-tab', 'timer-display', 'timer-start-pause', 'timer-reset', 'timer-fullscreen', 'wake-lock-toggle', 'new-task-input', 'add-task-btn', 'task-list', 'quick-notes', 
                'syllabus-tab', 'full-syllabus-container', 
                'tests-tab', 'mock-test-name', 'save-mock-test-btn', 'mock-tests-list',
                'formulas-tab', 'formula-subject', 'formula-chapter', 'formula-text', 'formula-notes', 'save-formula-btn', 'formula-search', 'formula-list',
                'flashcards-tab', 'flashcard-review-container', 'flashcard', 'flashcard-front-text', 'flashcard-back-text', 'flashcard-controls', 'flashcard-no-review-message', 'new-flashcard-front', 'new-flashcard-back', 'save-flashcard-btn',
                'analytics-tab', 'streak-days', 'mock-test-chart', 'mistake-chart', 'revision-list', 'achievements-display',
                'confirm-modal', 'confirm-title', 'confirm-message', 'confirm-ok-btn', 'confirm-cancel-btn',
                'mistake-log-modal', 'mistake-log-test-name', 'mistake-chapter', 'mistake-reason', 'save-mistake-btn', 'mistake-list', 'finish-mistake-log-btn',
                'pyq-modal', 'pyq-chapter-name', 'pyq-year-list', 'save-pyq-btn'
            ];
            const elements = {};
            ids.forEach(id => elements[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id));
            elements.navButtons = document.querySelectorAll('.nav-btn');
            elements.tabContents = document.querySelectorAll('.tab-content');
            elements.flashcardEaseButtons = document.querySelectorAll('#flashcard-controls button');
            elements.timerContainer = document.querySelector('.timer-container');
            return elements;
        },

        getData(key, defaultValue = null) { try { const data = JSON.parse(localStorage.getItem(key)); return data === null ? defaultValue : data; } catch (e) { return defaultValue; } },
        setData(key, value) { localStorage.setItem(key, JSON.stringify(value)); },
        getTodayDateString() { return new Date().toISOString().split('T')[0]; },
        
        showSetup() { this.dom.setupScreen.classList.remove('hidden'); this.dom.appContainer.classList.add('hidden'); },
        showApp() { this.dom.setupScreen.classList.add('hidden'); this.dom.appContainer.classList.remove('hidden'); this.updateDashboard(); },
        saveSetupData() {
            const name = this.dom.userName.value.trim();
            if (!name) { this.showCustomConfirm("Name Required", "Please enter your name.", () => {}, true); return; }
            this.setData('user', { name, xp: 0 });

            const syllabusStatus = {};
            const checkboxes = this.dom.setupSyllabusContainer.querySelectorAll('.syllabus-checkbox');
            for (const subject in syllabusData) {
                syllabusStatus[subject] = {};
                syllabusData[subject].forEach(chapter => {
                    const checkbox = Array.from(checkboxes).find(cb => cb.value === chapter);
                    syllabusStatus[subject][chapter] = { completed: checkbox.checked, completionDate: checkbox.checked ? this.getTodayDateString() : null };
                });
            }
            this.setData('syllabus', syllabusStatus);
            this.setData('studyStreak', { current: 0, lastUpdate: null });
            this.setData('longTermGoals', { weekly: '', monthly: '' });
            this.setData('quickNotes', '');
            this.setData('achievements', {});
            this.setData('mockTests', []);
            this.setData('flashcards', []);
            this.setData('formulas', []);
            this.setData('pyqs', {});
            this.showApp();
        },
        updateDashboard() {
            const user = this.getData('user');
            this.dom.welcomeMessage.textContent = `Hi, ${user.name}!`;
            this.dom.motivationalQuote.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            this.renderProgress(); this.renderDailyGoal(); this.renderTasks(); this.renderLongTermGoals(); this.updateGamification();
            this.renderAnalytics(); this.dom.quickNotes.value = this.getData('quickNotes', '');
            this.renderSyllabusChecklist(this.dom.fullSyllabusContainer, true);
        },

        renderSyllabusChecklist(container, loadState = false) {
            let html = '';
            const syllabusStatus = loadState ? this.getData('syllabus') : null;
            for (const subject in syllabusData) {
                html += `<div class="p-4 rounded-lg bg-gray-900/50 mb-4"><h3 class="text-lg font-bold text-blue-400 mb-3">${subject}</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2 gap-x-4">`;
                syllabusData[subject].forEach(chapter => {
                    const isChecked = syllabusStatus ? syllabusStatus[subject][chapter].completed : false;
                    html += `<div class="flex items-center justify-between"><label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer hover:text-white"><input type="checkbox" data-subject="${subject}" value="${chapter}" class="syllabus-checkbox form-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><span>${chapter}</span></label>${loadState ? `<button class="text-xs text-blue-400 hover:text-white pyq-btn" data-subject="${subject}" data-chapter="${chapter}">PYQ</button>` : ''}</div>`;
                });
                html += `</div></div>`;
            }
            container.innerHTML = html;
        },

        renderProgress() {
            const syllabusStatus = this.getData('syllabus'); if (!syllabusStatus) return;
            let total = 0, completed = 0, subjectProgress = {}; let html = '';
            for (const subject in syllabusData) {
                const chapters = syllabusData[subject]; const comp = chapters.filter(ch => syllabusStatus[subject][ch].completed).length;
                total += chapters.length; completed += comp;
                const p = chapters.length > 0 ? Math.round((comp / chapters.length) * 100) : 0;
                subjectProgress[subject] = p;
                html += `<div><div class="flex justify-between items-center mb-1"><span class="font-semibold">${subject}</span><span class="text-sm font-medium">${p}%</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${p}%"></div></div></div>`;
            }
            const overallP = total > 0 ? Math.round((completed / total) * 100) : 0;
            const overallHTML = `<div><div class="flex justify-between items-center mb-1"><span class="font-bold text-lg text-green-300">Overall Progress</span><span class="text-lg font-bold text-green-300">${overallP}%</span></div><div class="w-full bg-gray-700 rounded-full h-3"><div class="bg-green-500 h-3 rounded-full" style="width: ${overallP}%"></div></div></div><hr class="border-gray-700 my-4">`;
            this.dom.progressBars.innerHTML = overallHTML + html;
        },
        renderDailyGoal() {
            let goal = this.getData('dailyGoal', {}); const today = this.getTodayDateString();
            if (goal.date !== today) { goal = { date: today, text: '', completed: false }; this.setData('dailyGoal', goal); }
            if (!goal.text) { this.dom.dailyGoalContainer.innerHTML = `<p class="text-gray-400 mb-2">What's your primary objective today?</p><div class="flex gap-2"><input type="text" id="daily-goal-input" placeholder="e.g., Master Rotational Motion" class="flex-grow input-field rounded-lg p-2"><button id="set-goal-btn" class="btn-primary font-bold py-2 px-4 rounded-lg">Set</button></div>`; document.getElementById('set-goal-btn').onclick = () => this.setDailyGoal(); } 
            else { this.dom.dailyGoalContainer.innerHTML = `<div class="flex items-center justify-between p-4 rounded-lg bg-gray-800 border border-blue-500/50"><label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" id="complete-goal-checkbox" class="form-checkbox h-5 w-5" ${goal.completed ? 'checked' : ''}><span class="text-lg ${goal.completed ? 'line-through text-gray-500' : 'text-white'}">${goal.text}</span></label><button id="edit-goal-btn" class="text-sm text-gray-400 hover:text-white">Edit</button></div>`; document.getElementById('complete-goal-checkbox').onchange = (e) => this.toggleGoalCompletion(e.target.checked); document.getElementById('edit-goal-btn').onclick = () => this.editDailyGoal(); }
        },
        renderTasks() {
            let tasks = this.getData('tasks', []); const today = this.getTodayDateString(); const todaysTasks = tasks.filter(t => t.date === today);
            this.dom.taskList.innerHTML = todaysTasks.length ? '' : '<p class="text-gray-500 text-sm">No tasks added for today.</p>';
            todaysTasks.forEach((task, index) => { const li = document.createElement('li'); li.className = `task-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700/50 ${task.completed ? 'text-gray-500 line-through' : ''}`; li.innerHTML = `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" data-index="${index}" class="task-checkbox form-checkbox h-4 w-4" ${task.completed ? 'checked' : ''}><span>${task.text}</span></label><button data-index="${index}" class="delete-task-btn text-gray-500 hover:text-red-500 text-xs">X</button>`; this.dom.taskList.appendChild(li); });
        },
        renderLongTermGoals() {
            const goals = this.getData('longTermGoals', { weekly: '', monthly: '' });
            this.dom.longTermGoalsContainer.innerHTML = `<div><label class="block text-sm font-medium text-gray-300 mb-1">This Week's Goal</label><input type="text" id="weekly-goal" value="${goals.weekly}" class="w-full input-field rounded-lg p-2" placeholder="e.g., Finish Electrostatics"></div><div><label class="block text-sm font-medium text-gray-300 mb-1">This Month's Goal</label><input type="text" id="monthly-goal" value="${goals.monthly}" class="w-full input-field rounded-lg p-2" placeholder="e.g., Complete 12th Physics Part 1"></div>`;
            document.getElementById('weekly-goal').onchange = (e) => this.saveLongTermGoal('weekly', e.target.value);
            document.getElementById('monthly-goal').onchange = (e) => this.saveLongTermGoal('monthly', e.target.value);
        },
        saveLongTermGoal(type, value) { let goals = this.getData('longTermGoals'); goals[type] = value.trim(); this.setData('longTermGoals', goals); },
        updateGamification() {
            const user = this.getData('user'); const currentLevel = LEVELS.filter(l => user.xp >= l.xp).pop(); const nextLevel = LEVELS.find(l => user.xp < l.xp); let xpForNextLevel = 0; let progress = 100; if(nextLevel) { const levelXP = nextLevel.xp - currentLevel.xp; const userXPInLevel = user.xp - currentLevel.xp; progress = (userXPInLevel / levelXP) * 100; xpForNextLevel = nextLevel.xp; } this.dom.xpLevelDisplay.innerHTML = `<span class="font-bold text-lg text-green-400">${currentLevel.name}</span><span class="text-sm text-gray-400"> | ${user.xp} / ${nextLevel ? xpForNextLevel : ''} XP</span>`; this.dom.xpBar.style.width = `${progress}%`; this.checkAllAchievements(); this.renderAchievements();
        },
        renderAchievements() { const earned = this.getData('achievements', {}); let html = ''; for (const key in ACHIEVEMENTS) { const a = ACHIEVEMENTS[key]; const isEarned = earned[key]; html += `<div class="badge ${isEarned ? 'earned' : 'text-gray-500'}" title="${a.desc}"><i class="fas ${a.icon} mr-2"></i>${a.name}</div>`; } this.dom.achievementsDisplay.innerHTML = html; },
        
        saveMockTest() {
            const name = this.dom.mockTestName.value.trim();
            if (!name) { this.showCustomConfirm("Invalid Input", "Test name is required.", () => {}, true); return; }
            let tests = this.getData('mockTests', []);
            const testId = Date.now();
            const newTest = { id: testId, name, date: this.getTodayDateString(), scores: {}, mistakes: [] };
            let totalCorrect = 0, totalIncorrect = 0;
            ['phy', 'chem', 'math'].forEach(sub => {
                const correct = parseInt(document.querySelector(`.mock-input[data-subject="${sub}"][data-type="correct"]`).value) || 0;
                const incorrect = parseInt(document.querySelector(`.mock-input[data-subject="${sub}"][data-type="incorrect"]`).value) || 0;
                const unattempted = parseInt(document.querySelector(`.mock-input[data-subject="${sub}"][data-type="unattempted"]`).value) || 0;
                newTest.scores[sub] = { correct, incorrect, unattempted, total: (correct * 4) - incorrect };
                totalCorrect += correct;
                totalIncorrect += incorrect;
            });
            newTest.total = (totalCorrect * 4) - totalIncorrect;
            tests.push(newTest);
            this.setData('mockTests', tests);
            this.addXP(XP_VALUES.MOCK_TEST); this.checkAchievement('FIRST_MOCK'); if(newTest.total >= 150) this.checkAchievement('SCORE_150');
            this.dom.mockTestName.value = ''; document.querySelectorAll('.mock-input').forEach(i => i.value = '');
            this.renderMockTests(); this.renderAnalytics();
            this.openMistakeLogModal(testId);
        },
        openMistakeLogModal(testId) {
            this.currentTestId = testId;
            const tests = this.getData('mockTests');
            const test = tests.find(t => t.id === testId);
            this.dom.mistakeLogTestName.textContent = test.name;
            let chapterOptions = '<option value="">Select Chapter</option>';
            Object.values(syllabusData).flat().forEach(ch => chapterOptions += `<option value="${ch}">${ch}</option>`);
            this.dom.mistakeChapter.innerHTML = chapterOptions;
            this.renderMistakeList();
            this.dom.mistakeLogModal.classList.add('visible');
        },
        saveMistake() {
            const chapter = this.dom.mistakeChapter.value;
            const reason = this.dom.mistakeReason.value;
            if (!chapter) { alert("Please select a chapter."); return; }
            let tests = this.getData('mockTests');
            let test = tests.find(t => t.id === this.currentTestId);
            test.mistakes.push({ chapter, reason });
            this.setData('mockTests', tests);
            this.renderMistakeList();
        },
        renderMistakeList() {
            const tests = this.getData('mockTests');
            const test = tests.find(t => t.id === this.currentTestId);
            this.dom.mistakeList.innerHTML = test.mistakes.map(m => `<div class="text-sm bg-gray-800 p-1 rounded">${m.chapter} - <span class="font-semibold text-orange-400">${m.reason}</span></div>`).join('');
        },
        renderMockTests() {
            const tests = this.getData('mockTests', []);
            this.dom.mockTestsList.innerHTML = tests.length ? '' : '<p class="text-gray-500 text-sm">No mock tests logged yet.</p>';
            tests.forEach(t => {
                this.dom.mockTestsList.innerHTML += `<div class="bg-gray-800 p-3 rounded-lg"><div class="flex justify-between items-center"><p class="font-bold">${t.name}</p><p class="text-xl font-bold text-blue-400">${t.total}</p></div><p class="text-xs text-gray-400">P:${t.scores.phy.total} C:${t.scores.chem.total} M:${t.scores.math.total} | ${t.date}</p><button class="text-xs text-blue-400 mt-1 log-mistakes-btn" data-testid="${t.id}">Log/View Mistakes</button></div>`;
            });
        },

        populateFormulaInputs() {
            let subjectOptions = '<option value="">Select Subject</option>';
            for (const subject in syllabusData) subjectOptions += `<option value="${subject}">${subject}</option>`;
            this.dom.formulaSubject.innerHTML = subjectOptions;
            this.dom.formulaSubject.onchange = () => {
                const subject = this.dom.formulaSubject.value;
                let chapterOptions = '<option value="">Select Chapter</option>';
                if (subject && syllabusData[subject]) {
                    syllabusData[subject].forEach(ch => chapterOptions += `<option value="${ch}">${ch}</option>`);
                }
                this.dom.formulaChapter.innerHTML = chapterOptions;
            };
        },
        saveFormula() {
            const formula = {
                id: Date.now(), subject: this.dom.formulaSubject.value, chapter: this.dom.formulaChapter.value,
                text: this.dom.formulaText.value, notes: this.dom.formulaNotes.value
            };
            if (!formula.subject || !formula.chapter || !formula.text) { alert('Please fill all required fields.'); return; }
            let formulas = this.getData('formulas', []);
            formulas.push(formula); this.setData('formulas', formulas);
            this.dom.formulaText.value = this.dom.formulaNotes.value = '';
            this.renderFormulas();
        },
        renderFormulas() {
            const formulas = this.getData('formulas', []);
            const searchTerm = this.dom.formulaSearch.value.toLowerCase();
            const filtered = formulas.filter(f => f.text.toLowerCase().includes(searchTerm) || f.chapter.toLowerCase().includes(searchTerm) || f.notes.toLowerCase().includes(searchTerm));
            this.dom.formulaList.innerHTML = filtered.map(f => `<div class="bg-gray-800 p-3 rounded-lg"><p class="font-bold text-blue-300">${f.text}</p><p class="text-sm text-gray-300 mt-1">${f.notes}</p><p class="text-xs text-gray-500 mt-2">${f.subject} > ${f.chapter}</p></div>`).join('');
        },

        openPyqModal(subject, chapter) {
            this.currentPyqChapter = { subject, chapter };
            this.dom.pyqChapterName.textContent = chapter;
            const pyqs = this.getData('pyqs', {});
            const savedYears = pyqs[chapter] || [];
            let yearHTML = '';
            for (let year = 2027; year >= 2018; year--) {
                const isChecked = savedYears.includes(year);
                yearHTML += `<label class="flex items-center space-x-2"><input type="checkbox" value="${year}" class="pyq-year-checkbox" ${isChecked ? 'checked' : ''}><span>${year}</span></label>`;
            }
            this.dom.pyqYearList.innerHTML = yearHTML;
            this.dom.pyqModal.classList.add('visible');
        },
        savePyqData() {
            let pyqs = this.getData('pyqs', {});
            const checkedYears = Array.from(document.querySelectorAll('.pyq-year-checkbox:checked')).map(cb => parseInt(cb.value));
            pyqs[this.currentPyqChapter.chapter] = checkedYears;
            this.setData('pyqs', pyqs);
            this.dom.pyqModal.classList.remove('visible');
        },

        toggleTimerFullscreen() {
            if (!document.fullscreenElement) { this.dom.timerContainer.requestFullscreen().catch(err => alert(`Error: ${err.message}`)); } 
            else { document.exitFullscreen(); }
        },
        async toggleWakeLock() {
            if (this.dom.wakeLockToggle.checked) {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        this.wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock was released by the browser.');
                            this.dom.wakeLockToggle.checked = false;
                            this.wakeLock = null;
                        });
                        console.log('Wake Lock is active!');
                    } catch (err) {
                        console.log(`Wake Lock request failed: ${err.name}, ${err.message}`);
                        this.dom.wakeLockToggle.checked = false;
                        this.dom.wakeLockToggle.disabled = true;
                        this.showCustomConfirm("Feature Unavailable", "The 'Keep Screen On' feature could not be activated. This might be due to browser settings or permissions.", () => {}, true);
                    }
                } else {
                    console.log('Wake Lock API not supported.');
                    this.dom.wakeLockToggle.disabled = true;
                    this.showCustomConfirm("Feature Not Supported", "Your browser does not support the 'Keep Screen On' feature.", () => {}, true);
                }
            } else {
                if (this.wakeLock) {
                    this.wakeLock.release();
                    this.wakeLock = null;
                    console.log('Wake Lock released by user.');
                }
            }
        },
        
        renderAnalytics() {
            this.updateStreak();
            const streak = this.getData('studyStreak', { current: 0 }); this.dom.streakDays.textContent = streak.current;
            this.renderSmartRevisionList();
            this.renderMockTestChart();
            this.renderMistakeChart();
            this.renderAchievements();
        },
        renderSmartRevisionList() {
            const syllabus = this.getData('syllabus');
            const tests = this.getData('mockTests', []);
            let revisionMap = {};
            tests.flatMap(t => t.mistakes).filter(m => m.reason === 'Conceptual Gap').forEach(m => {
                if (!revisionMap[m.chapter]) revisionMap[m.chapter] = { reason: 'Conceptual Gap', count: 0 };
                revisionMap[m.chapter].count++;
            });
            const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30));
            for (const sub in syllabus) {
                for (const chap in syllabus[sub]) {
                    const d = syllabus[sub][chap];
                    if (d.completed && d.completionDate && new Date(d.completionDate) < thirtyDaysAgo && !revisionMap[chap]) {
                        revisionMap[chap] = { reason: 'Old Chapter', count: 1 };
                    }
                }
            }
            const sorted = Object.entries(revisionMap).sort((a,b) => b[1].count - a[1].count);
            let revisionHTML = sorted.map(([chapter, data]) => 
                `<li class="bg-gray-800 p-2 rounded-md text-sm">${chapter} <span class="text-xs ${data.reason === 'Conceptual Gap' ? 'text-red-400 font-bold' : 'text-gray-500'}">(${data.reason})</span></li>`
            ).join('');
            this.dom.revisionList.innerHTML = revisionHTML || `<li class="text-gray-500">No chapters due for revision yet.</li>`;
        },
        renderMistakeChart() {
            const tests = this.getData('mockTests', []);
            const mistakeCounts = { 'Conceptual Gap': 0, 'Silly Mistake': 0, 'Time Pressure': 0, 'Calculation Error': 0 };
            tests.flatMap(t => t.mistakes).forEach(m => mistakeCounts[m.reason]++);
            const ctx = this.dom.mistakeChart.getContext('2d');
            if (this.mistakeChart) this.mistakeChart.destroy();
            this.mistakeChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(mistakeCounts), datasets: [{ label: 'Mistake Types', data: Object.values(mistakeCounts), backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'], borderColor: '#18181b' }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        },
        renderMockTestChart() {
            const tests = this.getData('mockTests', []);
            const ctx = this.dom.mockTestChart.getContext('2d');
            if (this.mockTestChart) this.mockTestChart.destroy();
            this.mockTestChart = new Chart(ctx, {
                type: 'line', data: { labels: tests.map(t => t.name), datasets: [{ label: 'Total Score', data: tests.map(t => t.total), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: true, tension: 0.3 }] },
                options: { scales: { y: { beginAtZero: true, max: 300 } } }
            });
        },
        updateTimerDisplay() {
            const m = Math.floor(this.secondsLeft / 60); const s = this.secondsLeft % 60;
            this.dom.timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            const totalS = this.timerMode === 'focus' ? 1500 : 300;
            const deg = (totalS - this.secondsLeft) / totalS * 360;
            this.dom.timerDisplay.parentElement.style.background = `conic-gradient(#3b82f6 ${deg}deg, #27272a 0deg)`;
        },

        addEventListeners() {
            this.dom.saveSetupBtn.onclick = () => this.saveSetupData();
            this.dom.resetBtn.onclick = () => this.resetApp();
            this.dom.navButtons.forEach(btn => btn.onclick = () => this.switchTab(btn.dataset.tab));
            this.dom.confirmCancelBtn.onclick = () => this.hideCustomConfirm();
            this.dom.addTaskBtn.onclick = () => this.addTask();
            this.dom.newTaskInput.onkeypress = (e) => e.key === 'Enter' && this.addTask();
            this.dom.taskList.onclick = (e) => this.handleTaskInteraction(e);
            this.dom.quickNotes.onkeyup = (e) => this.setData('quickNotes', e.target.value);
            this.dom.timerStartPause.onclick = () => this.startPauseTimer();
            this.dom.timerReset.onclick = () => this.resetTimer();
            this.dom.timerFullscreen.onclick = () => this.toggleTimerFullscreen();
            this.dom.wakeLockToggle.onchange = () => this.toggleWakeLock();
            this.dom.fullSyllabusContainer.onchange = (e) => this.handleSyllabusCheck(e);
            this.dom.setupSyllabusContainer.onchange = (e) => this.handleSyllabusCheck(e);
            this.dom.fullSyllabusContainer.onclick = (e) => { if(e.target.classList.contains('pyq-btn')) this.openPyqModal(e.target.dataset.subject, e.target.dataset.chapter); };
            this.dom.savePyqBtn.onclick = () => this.savePyqData();
            this.dom.saveMockTestBtn.onclick = () => this.saveMockTest();
            this.dom.mockTestsList.onclick = (e) => { if(e.target.classList.contains('log-mistakes-btn')) this.openMistakeLogModal(parseInt(e.target.dataset.testid)); };
            this.dom.saveMistakeBtn.onclick = () => this.saveMistake();
            this.dom.finishMistakeLogBtn.onclick = () => this.dom.mistakeLogModal.classList.remove('visible');
            this.dom.saveFormulaBtn.onclick = () => this.saveFormula();
            this.dom.formulaSearch.onkeyup = () => this.renderFormulas();
            this.dom.saveFlashcardBtn.onclick = () => this.saveFlashcard();
            this.dom.flashcard.onclick = () => this.flipFlashcard();
            this.dom.flashcardEaseButtons.forEach(btn => btn.onclick = (e) => { e.stopPropagation(); this.rateFlashcard(btn.dataset.ease); });
        },

        addTask() { const text = this.dom.newTaskInput.value.trim(); if (text) { let tasks = this.getData('tasks', []); const today = this.getTodayDateString(); tasks.push({ text, completed: false, date: today }); this.setData('tasks', tasks); this.renderTasks(); this.dom.newTaskInput.value = ''; } },
        handleTaskInteraction(e) {
            const index = e.target.dataset.index; if (index === undefined) return; let tasks = this.getData('tasks', []); const today = this.getTodayDateString(); const todaysTasksIndices = tasks.map((t, i) => t.date === today ? i : -1).filter(i => i !== -1); const actualIndex = todaysTasksIndices[index];
            if (e.target.classList.contains('task-checkbox')) { if (tasks[actualIndex].completed !== e.target.checked) { if(e.target.checked) this.addXP(XP_VALUES.TASK); else this.addXP(-XP_VALUES.TASK); } tasks[actualIndex].completed = e.target.checked; } 
            if (e.target.classList.contains('delete-task-btn')) { if(tasks[actualIndex].completed) this.addXP(-XP_VALUES.TASK); tasks.splice(actualIndex, 1); }
            this.setData('tasks', tasks); this.renderTasks();
        },
        setDailyGoal() { const text = document.getElementById('daily-goal-input').value.trim(); if (text) this.setData('dailyGoal', { date: this.getTodayDateString(), text, completed: false }); this.renderDailyGoal(); },
        editDailyGoal() { let goal = this.getData('dailyGoal'); goal.text = ''; this.setData('dailyGoal', goal); this.renderDailyGoal(); },
        toggleGoalCompletion(isCompleted) { let goal = this.getData('dailyGoal'); if(goal.completed !== isCompleted) { if(isCompleted) { this.addXP(XP_VALUES.GOAL); this.checkAchievement('FIRST_GOAL'); } else { this.addXP(-XP_VALUES.GOAL); } } goal.completed = isCompleted; this.setData('dailyGoal', goal); this.renderDailyGoal(); this.updateStreak(); },
        handleSyllabusCheck(e) {
            if (!e.target.classList.contains('syllabus-checkbox')) return;
            const subject = e.target.dataset.subject, chapter = e.target.value;
            let syllabusStatus = this.getData('syllabus');
            if (syllabusStatus && syllabusStatus[subject] && syllabusStatus[subject][chapter]) {
                if(syllabusStatus[subject][chapter].completed !== e.target.checked) { if(e.target.checked) { this.addXP(XP_VALUES.CHAPTER); this.checkAchievement('FIRST_CHAPTER'); } else { this.addXP(-XP_VALUES.CHAPTER); } }
                syllabusStatus[subject][chapter].completed = e.target.checked;
                syllabusStatus[subject][chapter].completionDate = e.target.checked ? this.getTodayDateString() : null;
                this.setData('syllabus', syllabusStatus);
                this.renderProgress();
                this.renderAnalytics();
                const otherListSelector = e.target.closest('#setup-syllabus-container') ? '#full-syllabus-container' : '#setup-syllabus-container';
                const otherCheckbox = document.querySelector(`${otherListSelector} input[value="${chapter}"]`);
                if (otherCheckbox) otherCheckbox.checked = e.target.checked;
            }
        },
        startPauseTimer() { if (this.timerState === 'running') { clearInterval(this.timerInterval); this.timerState = 'paused'; this.dom.timerStartPause.innerHTML = '<i class="fas fa-play"></i>'; } else { this.timerState = 'running'; this.dom.timerStartPause.innerHTML = '<i class="fas fa-pause"></i>'; this.timerInterval = setInterval(() => { this.secondsLeft--; this.updateTimerDisplay(); if (this.secondsLeft <= 0) { clearInterval(this.timerInterval); this.switchTimerMode(); } }, 1000); } },
        resetTimer() { clearInterval(this.timerInterval); this.timerState = 'stopped'; this.timerMode = 'focus'; this.secondsLeft = 1500; this.updateTimerDisplay(); this.dom.timerStartPause.innerHTML = '<i class="fas fa-play"></i>'; },
        switchTimerMode() { this.timerMode = this.timerMode === 'focus' ? 'break' : 'focus'; this.secondsLeft = this.timerMode === 'focus' ? 1500 : 300; this.timerState = 'stopped'; this.updateTimerDisplay(); this.dom.timerStartPause.innerHTML = '<i class="fas fa-play"></i>'; this.showCustomConfirm(this.timerMode === 'break' ? "Focus Complete!" : "Break's Over!", this.timerMode === 'break' ? "Time for a short 5-min break." : "Time to get back to focus.", () => this.startPauseTimer(), true); },
        saveFlashcard() { const front = this.dom.newFlashcardFront.value.trim(); const back = this.dom.newFlashcardBack.value.trim(); if(!front || !back) return; let cards = this.getData('flashcards', []); cards.push({ id: Date.now(), front, back, interval: 1, easeFactor: 2.5, dueDate: this.getTodayDateString() }); this.setData('flashcards', cards); this.dom.newFlashcardFront.value = this.dom.newFlashcardBack.value = ''; this.showCustomConfirm("Success", "Flashcard created!", () => {}, true); },
        renderFlashcard() { const cards = this.getData('flashcards', []); const today = this.getTodayDateString(); const dueCards = cards.filter(c => c.dueDate <= today); if(dueCards.length > 0) { this.currentFlashcardIndex = cards.indexOf(dueCards[0]); this.dom.flashcardReviewContainer.classList.remove('hidden'); this.dom.flashcardNoReviewMessage.textContent = ''; this.dom.flashcard.classList.remove('is-flipped'); this.dom.flashcardFrontText.textContent = dueCards[0].front; this.dom.flashcardBackText.textContent = dueCards[0].back; this.dom.flashcardControls.classList.add('hidden'); } else { this.dom.flashcardReviewContainer.classList.add('hidden'); this.dom.flashcardNoReviewMessage.textContent = 'No flashcards to review today. Great job!'; this.currentFlashcardIndex = -1; } },
        flipFlashcard() { if (this.currentFlashcardIndex === -1) return; this.dom.flashcard.classList.toggle('is-flipped'); this.dom.flashcardControls.classList.toggle('hidden'); },
        rateFlashcard(ease) { let cards = this.getData('flashcards', []); let card = cards[this.currentFlashcardIndex]; const addDays = (days) => { const date = new Date(); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; }; if (ease === 'hard') { card.interval = 1; card.easeFactor = Math.max(1.3, card.easeFactor - 0.2); } else { if (ease === 'good') card.interval = Math.ceil(card.interval * card.easeFactor); if (ease === 'easy') { card.interval = Math.ceil(card.interval * card.easeFactor * 1.5); card.easeFactor += 0.15; } } card.dueDate = addDays(card.interval); this.setData('flashcards', cards); this.renderFlashcard(); },
        showCustomConfirm(title, message, callback, isAlert = false) { this.dom.confirmTitle.textContent = title; this.dom.confirmMessage.textContent = message; this.dom.confirmOkBtn.onclick = () => { callback(); this.hideCustomConfirm(); }; this.dom.confirmCancelBtn.style.display = isAlert ? 'none' : 'block'; this.dom.confirmOkBtn.textContent = isAlert ? 'OK' : 'Confirm'; this.dom.confirmOkBtn.className = `font-semibold py-2 px-5 rounded-lg ${isAlert ? 'btn-primary' : 'bg-red-600 hover:bg-red-700 text-white'}`; this.dom.confirmModal.classList.add('visible'); },
        hideCustomConfirm() { this.dom.confirmModal.classList.remove('visible'); },
        resetApp() { this.showCustomConfirm('Reset Progress?', 'This will erase all your data. Are you sure?', () => { localStorage.clear(); window.location.reload(); }); },
        switchTab(tabId) {
            this.dom.tabContents.forEach(tc => tc.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            this.dom.navButtons.forEach(nb => nb.classList.remove('active'));
            document.querySelector(`.nav-btn[data-tab="${tabId}"]`).classList.add('active');
            if (tabId === 'analytics-tab') this.renderAnalytics();
            if (tabId === 'flashcards-tab') this.renderFlashcard();
            if (tabId === 'formulas-tab') this.renderFormulas();
        },
        updateStreak() { let streak = this.getData('studyStreak', { current: 0, lastUpdate: null }); const today = this.getTodayDateString(); const goal = this.getData('dailyGoal', {}); if (goal.date === today && goal.completed && streak.lastUpdate !== today) { const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0]; streak.current = streak.lastUpdate === yesterday ? streak.current + 1 : 1; streak.lastUpdate = today; this.setData('studyStreak', streak); this.checkAllAchievements(); } },
        checkAchievement(key) { let achievements = this.getData('achievements', {}); if (!achievements[key]) { achievements[key] = true; this.setData('achievements', achievements); this.showCustomConfirm("Achievement Unlocked!", ACHIEVEMENTS[key].name, () => {}, true); } },
        checkAllAchievements() {
            const streak = this.getData('studyStreak', { current: 0 });
            if (streak.current >= 5) this.checkAchievement('STREAK_5');
            if (streak.current >= 10) this.checkAchievement('STREAK_10');
            const syllabus = this.getData('syllabus'); if(!syllabus) return;
            ['Physics', 'Chemistry', 'Mathematics'].forEach(sub => { const total = syllabusData[sub].length; const completed = Object.values(syllabus[sub]).filter(c => c.completed).length; if( (completed/total) >= 0.25) this.checkAchievement(`${sub.toUpperCase()}_25`); });
        },
        addXP(amount) { let user = this.getData('user'); user.xp += amount; this.setData('user', user); this.updateGamification(); }
    };
    app.init();
});
</script>
</body>
</html>

