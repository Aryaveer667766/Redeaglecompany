<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit Pulse - Daily Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekOfYear.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_weekday);
        dayjs.extend(dayjs_plugin_weekOfYear);
    </script>
    <style>
        :root {
            --brand-indigo: #6366F1;
            --brand-purple: #8B5CF6;
            --background-dark: #0a0a0a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: #e5e5e5;
            -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            background: radial-gradient(circle at top left, #0a0a0a 0%, #14141e 50%, #0a0a0a 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--brand-indigo), var(--brand-purple));
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .calendar-day { transition: all 0.2s ease; }
        .calendar-day.active {
            background: var(--brand-indigo);
            color: white;
            transform: scale(1.1);
        }
        .calendar-day:not(.active):hover { background: var(--card-bg); }
        .workout-item { border-left: 4px solid var(--brand-purple); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--brand-purple); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand-indigo); }

        /* Timer Styles */
        #timer-progress-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .pulsate { animation: pulsate 2s infinite ease-in-out; }
        @keyframes pulsate {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="main-container">

    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto animate-fade-in">
        <header class="flex justify-between items-center mb-8 animate-slide-up" style="animation-delay: 0.1s;">
             <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wider">Fit Pulse</h1>
            </div>
            <div id="current-date" class="hidden md:block text-lg font-medium text-gray-400"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Weekly Planner</h2>
                        <div class="flex items-center gap-2">
                            <button id="prev-week" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            </button>
                            <span id="current-month-year" class="font-semibold w-28 text-center"></span>
                            <button id="next-week" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="calendar-container" class="grid grid-cols-7 gap-2 md:gap-4"></div>
                </div>

                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 sm:gap-0">
                        <div>
                            <h2 class="text-xl font-bold text-white">Today's Plan</h2>
                            <p id="selected-date-display" class="text-gray-400"></p>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button id="add-workout-btn" class="btn-primary font-semibold py-2 px-4 rounded-lg flex items-center gap-2 w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add Workout
                            </button>
                        </div>
                    </div>
                    <div id="workout-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div class="space-y-8">
                <div id="workout-templates-card" class="glass-card p-6 animate-slide-up cursor-pointer" style="animation-delay: 0.4s;">
                     <h2 class="text-xl font-bold text-white mb-2">Workout Templates</h2>
                     <p class="text-gray-400 text-sm">Get started quickly with pre-made workout plans.</p>
                </div>
                 <div id="diet-planner-card" class="glass-card p-6 animate-slide-up cursor-pointer" style="animation-delay: 0.5s;">
                     <h2 class="text-xl font-bold text-white mb-2">Daily Diet Planner</h2>
                     <p class="text-gray-400 text-sm">Create a personalized daily diet plan to match your goals.</p>
                </div>
                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.6s;">
                    <h2 class="text-xl font-bold text-white mb-4">Weekly Progress</h2>
                    <div id="progress-container" class="flex justify-around items-end h-32"></div>
                </div>
                <div class="glass-card p-6 animate-slide-up" style="animation-delay: 0.7s;">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h3l2.5 3h5L20 16h-3a2 2 0 0 0-2-2V6a2 2 0 0 0-2-2z"></path><path d="M14.5 4a2 2 0 0 1 2 2v2"></path></svg>
                        Daily Motivation
                    </h2>
                    <blockquote id="motivation-quote" class="text-gray-300 italic text-center text-lg"></blockquote>
                    <p id="motivation-author" class="text-right text-gray-400 font-semibold mt-3 text-sm"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container">
        <!-- Add/Edit Workout Modal -->
        <div id="workout-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-indigo-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 id="workout-modal-title" class="text-2xl font-bold mb-4 text-white"></h2>
                <form id="workout-form">
                    <input type="hidden" id="workout-id">
                    <div class="mb-4">
                        <label for="workout-name" class="block text-sm font-medium text-gray-300 mb-1">Workout Name</label>
                        <input type="text" id="workout-name" placeholder="e.g., Bench Press" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label for="workout-type" class="block text-sm font-medium text-gray-300 mb-1">Workout Type</label>
                        <select id="workout-type" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <option>Strength</option> <option>Cardio</option> <option>Flexibility</option> <option>Rest Day</option>
                        </select>
                    </div>
                     <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="workout-duration" class="block text-sm font-medium text-gray-300 mb-1">Duration (min)</label>
                            <input type="number" id="workout-duration" placeholder="45" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                        </div>
                        <div id="sets-input-container">
                            <label for="workout-sets" class="block text-sm font-medium text-gray-300 mb-1">Number of Sets</label>
                            <input type="number" id="workout-sets" placeholder="3" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Save Workout</button>
                </form>
            </div>
        </div>
        <!-- Workout Tracker Modal -->
        <div id="tracker-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-green-500/50 relative animate-slide-up">
                 <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                 </button>
                <h2 id="tracker-modal-title" class="text-2xl font-bold mb-1 text-white text-center"></h2>
                <p id="tracker-progress-header" class="text-center font-semibold text-indigo-300 mb-6"></p>

                <div id="tracker-view-container">
                    <!-- Set Logging View -->
                    <div id="tracker-set-view">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-center text-sm text-gray-400 mb-1">Weight (kg)</label>
                                <input id="tracker-weight-input" type="number" step="0.5" class="w-full text-3xl font-bold bg-white/5 border-2 border-white/10 rounded-lg p-3 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-center text-sm text-gray-400 mb-1">Reps</label>
                                <input id="tracker-reps-input" type="number" class="w-full text-3xl font-bold bg-white/5 border-2 border-white/10 rounded-lg p-3 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <p class="text-center text-gray-400 text-sm mb-4">Previous: <span id="tracker-previous-set-data">--</span></p>
                        <button id="log-set-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">Log Set & Rest</button>
                    </div>
                    <!-- Rest Timer View -->
                    <div id="tracker-rest-view" class="hidden text-center">
                        <p class="text-lg text-gray-400">REST</p>
                        <p id="rest-timer-display" class="text-7xl font-bold my-4 text-white">01:00</p>
                        <div class="flex justify-center gap-4">
                            <button id="skip-rest-btn" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Skip</button>
                            <button id="add-time-btn" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">+30s</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <button id="prev-set-btn" class="btn-secondary text-sm py-2 px-3 rounded-lg">&lt; Prev Set</button>
                    <button id="finish-workout-btn" class="btn-primary font-bold py-2 px-4 rounded-lg">Finish Workout</button>
                    <button id="next-set-btn" class="btn-secondary text-sm py-2 px-3 rounded-lg">Next Set &gt;</button>
                </div>
            </div>
        </div>
        <!-- Template Select Modal -->
        <div id="template-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-lg p-6 rounded-2xl border-2 border-purple-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 text-white">Choose a Template</h2>
                <div id="template-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
        <!-- Timer Modal -->
        <div id="timer-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center p-4 z-50 hidden animate-fade-in">
            <div class="relative w-64 h-64 flex items-center justify-center mb-8">
                <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="timer-progress-circle" class="text-indigo-400" stroke-width="5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <div id="time-display" class="text-5xl font-bold text-white z-10">00:00</div>
            </div>
            <h3 id="timer-workout-name" class="text-xl font-semibold mb-8 text-gray-300"></h3>
            <div class="flex items-center gap-6">
                <button id="pause-resume-btn" class="text-gray-300 hover:text-white transition-colors p-4 bg-white/10 rounded-full">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button id="stop-timer-btn" class="text-gray-300 hover:text-white transition-colors p-4 bg-red-500/20 hover:bg-red-500/40 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                </button>
            </div>
        </div>
        <!-- Diet Creator Modal -->
        <div id="diet-creator-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
             <div class="glass-card w-full max-w-md p-6 rounded-2xl border-2 border-emerald-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 text-white">Create Your Diet Plan</h2>
                <form id="diet-creator-form">
                    <div class="mb-4">
                        <label for="diet-preference" class="block text-sm font-medium text-gray-300 mb-1">Dietary Preference</label>
                        <select id="diet-preference" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
                            <option value="veg">Vegetarian</option>
                            <option value="nonveg">Non-Vegetarian</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="diet-goal" class="block text-sm font-medium text-gray-300 mb-1">Primary Goal</label>
                        <select id="diet-goal" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
                            <option value="loss">Weight Loss</option>
                            <option value="gain">Weight Gain</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Generate Diet Plan</button>
                </form>
            </div>
        </div>
        <!-- Diet Plan Display Modal -->
        <div id="diet-plan-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden animate-fade-in">
            <div class="glass-card w-full max-w-lg p-6 rounded-2xl border-2 border-emerald-500/50 relative animate-slide-up">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 id="diet-plan-title" class="text-2xl font-bold mb-4 text-white">Your Daily Diet Plan</h2>
                <div id="diet-plan-content" class="text-gray-300 max-h-96 overflow-y-auto pr-2 space-y-4"></div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONSTANTS ---
            let currentDate = dayjs();
            let selectedDate = dayjs().format('YYYY-MM-DD');
            let workouts = JSON.parse(localStorage.getItem('fitPulseWorkouts')) || {};
            
            let timerInterval;
            let timeRemaining;
            let totalTime;
            let isPaused = false;
            
            let currentWorkoutId = null;
            let currentSetIndex = 0;
            let restTimerInterval = null;
            let restTimeRemaining = 60;

            const MOTIVATIONAL_QUOTES = [
                { quote: "The only bad workout is the one that didn't happen.", author: "Anonymous" },
                { quote: "Strive for progress, not perfection.", author: "Anonymous" },
                { quote: "Your body can stand almost anything. It’s your mind that you have to convince.", author: "Anonymous" },
                { quote: "Success isn’t always about greatness. It’s about consistency. Consistent hard work leads to success. Greatness will come.", author: "Dwayne Johnson" },
                { quote: "The last three or four reps is what makes the muscle grow. This area of pain divides a champion from someone who is not a champion.", author: "Arnold Schwarzenegger" },
                { quote: "Don’t count the days, make the days count.", author: "Muhammad Ali" },
                { quote: "The clock is ticking. Are you becoming the person you want to be?", author: "Greg Plitt" },
                { quote: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" }
            ];

            // --- ICONS & TEMPLATES DATA ---
            const ICONS = {
                Strength: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M12 1a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M12 18a9 9 0 0 0 9-9h-1.09a7 7 0 0 1-1.42 4.22l-1.42 1.42a3 3 0 0 0-4.14 0l-1.42-1.42A7 7 0 0 1 4.09 9H3a9 9 0 0 0 9 9z"></path></svg>`,
                Cardio: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>`,
                Flexibility: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400"><path d="M12.83 2.17a2 2 0 0 0-1.66 0L2.6 6.33a2 2 0 0 0-1 1.73v7.88a2 2 0 0 0 1 1.73l8.53 4.16a2 2 0 0 0 1.66 0l8.53-4.16a2 2 0 0 0 1-1.73V8.06a2 2 0 0 0-1-1.73Z"></path><path d="m12 14 4-4"></path><path d="m16 14-4-4"></path><path d="m8 10 4 4"></path></svg>`,
                'Rest Day': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>`
            };

            const WORKOUT_TEMPLATES = [
                { name: "Full Body Strength", plan: [ { d:0, n:"Upper Body Strength", type:"Strength", min:60, sets: 5 }, { d:2, n:"Lower Body Power", type:"Strength", min:60, sets: 5 }, { d:4, n:"Core & Back", type:"Strength", min:45, sets: 4 }, { d:6, n:"Full Body HIIT", type:"Cardio", min:30, sets: 0 } ] },
                { name: "Cardio Blast", plan: [ { d:0, n:"Running Intervals", type:"Cardio", min:30 }, { d:1, n:"Cycling", type:"Cardio", min:45 }, { d:3, n:"HIIT Cardio", type:"Cardio", min:25 }, { d:5, n:"Long Steady Run", type:"Cardio", min:60 } ] },
                { name: "Flexibility & Flow", plan: [ { d:0, n:"Morning Yoga", type:"Flexibility", min:30 }, { d:2, n:"Deep Stretch", type:"Flexibility", min:45 }, { d:4, n:"Restorative Yoga", type:"Flexibility", min:60 } ] },
                { name: "Push/Pull/Legs Split", plan: [ { d: 0, n: "Push (Chest, Shoulders, Triceps)", type: "Strength", min: 60, sets: 5 }, { d: 1, n: "Pull (Back, Biceps)", type: "Strength", min: 60, sets: 5 }, { d: 2, n: "Legs (Quads, Hamstrings, Calves)", type: "Strength", min: 75, sets: 5 }, { d: 3, n: "Rest", type: "Rest Day", min: 0 }, { d: 4, n: "Push 2", type: "Strength", min: 60, sets: 5 }, { d: 5, n: "Pull 2", type: "Strength", min: 60, sets: 5 }, { d: 6, n: "Active Recovery", type: "Flexibility", min: 30 } ] },
                { name: "Home Bodyweight Circuit", plan: [ { d: 0, n: "Full Body Circuit A", type: "Strength", min: 30, sets: 3 }, { d: 2, n: "Full Body Circuit B", type: "Strength", min: 30, sets: 3 }, { d: 4, n: "Full Body Circuit C", type: "Strength", min: 30, sets: 3 }, { d: 6, n: "Yoga & Stretching", type: "Flexibility", min: 20 } ] }
            ];

            const DIET_PLANS = {
                veg: {
                    gain: {
                        title: "Vegetarian Weight Gain Plan",
                        meals: {
                            Breakfast: "2 Paneer Parathas with curd, and a handful of almonds.",
                            Lunch: "Large bowl of Rajma/Chole, brown rice, mixed vegetable curry, and a side salad.",
                            Snack: "A large banana smoothie with milk, oats, and a scoop of peanut butter.",
                            Dinner: "Tofu/Soya chunks curry, 2 multigrain rotis, dal, and a glass of milk before bed."
                        }
                    },
                    loss: {
                        title: "Vegetarian Weight Loss Plan",
                        meals: {
                            Breakfast: "Bowl of oats with berries and a few nuts. A cup of green tea.",
                            Lunch: "Mixed vegetable salad with chickpeas and a light lemon dressing, one multigrain roti with dal.",
                            Snack: "An apple and a small bowl of sprouts.",
                            Dinner: "Grilled Paneer/Tofu with sauteed vegetables. A bowl of clear vegetable soup."
                        }
                    }
                },
                nonveg: {
                    gain: {
                        title: "Non-Vegetarian Weight Gain Plan",
                        meals: {
                            Breakfast: "4 boiled eggs (2 whole, 2 whites), whole wheat toast with avocado, and a glass of milk.",
                            Lunch: "150g grilled chicken breast, a cup of brown rice, a bowl of dal, and a large salad.",
                            Snack: "A handful of mixed nuts and a protein shake.",
                            Dinner: "150g fish curry, 2 multigrain rotis, and mixed vegetables."
                        }
                    },
                    loss: {
                        title: "Non-Vegetarian Weight Loss Plan",
                        meals: {
                            Breakfast: "3 boiled egg whites, with a side of papaya. Green tea.",
                            Lunch: "100g grilled chicken or fish salad with lots of leafy greens and a light vinaigrette.",
                            Snack: "A bowl of curd/yogurt.",
                            Dinner: "100g chicken/fish soup with plenty of vegetables."
                        }
                    }
                }
            };

            // --- DOM ELEMENTS ---
            const allElements = {
                currentDateEl: document.getElementById('current-date'),
                calendarContainer: document.getElementById('calendar-container'),
                currentMonthYearEl: document.getElementById('current-month-year'),
                selectedDateDisplay: document.getElementById('selected-date-display'),
                workoutList: document.getElementById('workout-list'),
                progressContainer: document.getElementById('progress-container'),
                workoutModal: document.getElementById('workout-modal'),
                workoutModalTitle: document.getElementById('workout-modal-title'),
                workoutForm: document.getElementById('workout-form'),
                workoutIdInput: document.getElementById('workout-id'),
                workoutNameInput: document.getElementById('workout-name'),
                workoutTypeInput: document.getElementById('workout-type'),
                workoutDurationInput: document.getElementById('workout-duration'),
                workoutSetsInput: document.getElementById('workout-sets'),
                setsInputContainer: document.getElementById('sets-input-container'),
                trackerModal: document.getElementById('tracker-modal'),
                trackerModalTitle: document.getElementById('tracker-modal-title'),
                trackerProgressHeader: document.getElementById('tracker-progress-header'),
                trackerSetView: document.getElementById('tracker-set-view'),
                trackerRestView: document.getElementById('tracker-rest-view'),
                trackerWeightInput: document.getElementById('tracker-weight-input'),
                trackerRepsInput: document.getElementById('tracker-reps-input'),
                trackerPreviousSetData: document.getElementById('tracker-previous-set-data'),
                restTimerDisplay: document.getElementById('rest-timer-display'),
                prevSetBtn: document.getElementById('prev-set-btn'),
                nextSetBtn: document.getElementById('next-set-btn'),
                templateModal: document.getElementById('template-modal'),
                templateList: document.getElementById('template-list'),
                timerModal: document.getElementById('timer-modal'),
                timeDisplay: document.getElementById('time-display'),
                timerProgressCircle: document.getElementById('timer-progress-circle'),
                timerWorkoutName: document.getElementById('timer-workout-name'),
                pauseResumeBtn: document.getElementById('pause-resume-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationAuthor: document.getElementById('motivation-author'),
                dietPlannerCard: document.getElementById('diet-planner-card'),
                dietCreatorModal: document.getElementById('diet-creator-modal'),
                dietCreatorForm: document.getElementById('diet-creator-form'),
                dietPlanModal: document.getElementById('diet-plan-modal'),
                dietPlanTitle: document.getElementById('diet-plan-title'),
                dietPlanContent: document.getElementById('diet-plan-content'),
            };

            // --- CORE FUNCTIONS ---
            const saveAndRerender = () => {
                localStorage.setItem('fitPulseWorkouts', JSON.stringify(workouts));
                renderCalendar();
                renderWorkouts();
                renderProgress();
            };

            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            const findWorkoutById = (workoutId) => {
                if (!workouts[selectedDate]) return null;
                return workouts[selectedDate].find(w => w.id === workoutId);
            };
            
            const findWorkoutIndexById = (workoutId) => {
                if (!workouts[selectedDate]) return -1;
                return workouts[selectedDate].findIndex(w => w.id === workoutId);
            }

            const renderMotivation = () => {
                if (allElements.motivationQuote && allElements.motivationAuthor) {
                    const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length);
                    const { quote, author } = MOTIVATIONAL_QUOTES[randomIndex];
                    allElements.motivationQuote.textContent = `“${quote}”`;
                    allElements.motivationAuthor.textContent = `— ${author}`;
                }
            };

            // --- RENDERING FUNCTIONS ---
            const renderCalendar = () => {
                allElements.calendarContainer.innerHTML = '';
                const startOfWeek = currentDate.startOf('week');
                allElements.currentMonthYearEl.textContent = startOfWeek.format('MMMM YYYY');
                
                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dateStr = day.format('YYYY-MM-DD');
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day text-center p-2 md:p-3 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-1 ${dateStr === selectedDate ? 'active' : ''}`;
                    dayEl.dataset.date = dateStr;
                    const dayWorkouts = workouts[dateStr] || [];
                    const isCompleted = dayWorkouts.length > 0 && dayWorkouts.every(w => w.completed);
                    const isPlanned = dayWorkouts.length > 0;
                    
                    dayEl.innerHTML = `
                        <span class="text-xs md:text-sm uppercase font-semibold text-gray-400 ${dateStr === selectedDate ? 'text-white/80' : ''}">${day.format('ddd')}</span>
                        <span class="text-lg md:text-xl font-bold">${day.format('D')}</span>
                        <div class="w-1.5 h-1.5 rounded-full ${isCompleted ? 'bg-green-400' : isPlanned ? 'bg-purple-400' : 'bg-transparent'}"></div>
                    `;
                    dayEl.addEventListener('click', () => { 
                        selectedDate = dateStr; 
                        renderCalendar(); 
                        renderWorkouts(); 
                    });
                    allElements.calendarContainer.appendChild(dayEl);
                }
            };
            
            const renderWorkouts = () => {
                allElements.selectedDateDisplay.textContent = dayjs(selectedDate).format('dddd, MMMM D, YYYY');
                allElements.workoutList.innerHTML = '';
                const dayWorkouts = workouts[selectedDate] || [];

                if (dayWorkouts.length === 0) {
                    allElements.workoutList.innerHTML = `<div class="text-center py-8"><p class="text-gray-400">No workouts planned for this day.</p><p class="text-gray-500 text-sm">Add a workout or apply a template!</p></div>`;
                    return;
                }

                dayWorkouts.forEach(workout => {
                    const workoutEl = document.createElement('div');
                    workoutEl.className = `workout-item bg-white/5 p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 animate-fade-in`;
                    
                    const totalSets = workout.totalSets || 0;
                    const completedSetsCount = workout.setsData ? workout.setsData.filter(s => s && s.completed).length : 0;
                    
                    let progressText;
                    if (workout.type === 'Strength' && totalSets > 0) {
                        progressText = `Sets: ${completedSetsCount} / ${totalSets} &bull; ${workout.duration} mins`;
                    } else {
                        progressText = `${workout.type} &bull; ${workout.duration} mins`;
                    }

                    if (workout.completed) {
                        progressText += ` &bull; <span class="text-green-400 font-semibold">Completed</span>`;
                    }

                    let loggedText = '';
                    if (workout.completed && completedSetsCount > 0) {
                        const bestSet = workout.setsData.reduce((best, current) => {
                           if (!current || !current.weight) return best;
                           return parseFloat(current.weight) > parseFloat(best.weight) ? current : best;
                        }, {weight: 0, reps: 0});
                        loggedText = `<p class="text-xs text-gray-500">Best set: ${bestSet.reps} reps at ${bestSet.weight} kg</p>`;
                    }

                    let actionButtonsHTML = '';
                    if (workout.type === 'Strength' && totalSets > 0) {
                        actionButtonsHTML = `
                            <button class="track-btn p-2 rounded-full hover:bg-white/10 ${workout.completed ? 'hidden' : ''}" data-id="${workout.id}" title="Track Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1V21c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h7.8c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V6.5L15.5 2z"></path><path d="M15 2v5h5"></path><path d="M10 16h4"></path><path d="M10 12h4"></path><path d="M10 8h2"></path></svg>
                            </button>`;
                    } else { // For Cardio, Flexibility, Rest Day, or Strength with 0 sets
                        actionButtonsHTML = `
                            <button class="start-timer-btn p-2 rounded-full hover:bg-white/10 ${workout.completed ? 'hidden' : ''}" data-id="${workout.id}" title="Start Timer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </button>
                            <button class="log-btn p-2 rounded-full hover:bg-white/10 ${workout.completed ? 'hidden' : ''}" data-id="${workout.id}" title="Mark Complete">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            </button>`;
                    }

                    workoutEl.innerHTML = `
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-black/20 shrink-0">${ICONS[workout.type] || ICONS['Strength']}</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg">${workout.name}</h3>
                                <p class="text-sm text-gray-400">${progressText}</p>
                                ${loggedText}
                            </div>
                        </div>
                        <div class="flex items-center gap-1 self-end sm:self-center">
                            ${actionButtonsHTML}
                            <button class="edit-btn p-2 rounded-full hover:bg-white/10" data-id="${workout.id}" title="Edit Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="delete-btn p-2 rounded-full hover:bg-white/10" data-id="${workout.id}" title="Delete Workout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    allElements.workoutList.appendChild(workoutEl);
                });
                attachWorkoutEventListeners();
            };

            const renderProgress = () => {
                allElements.progressContainer.innerHTML = '';
                const startOfWeek = currentDate.startOf('week');
                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dateStr = day.format('YYYY-MM-DD');
                    const dayWorkouts = workouts[dateStr] || [];
                    const completed = dayWorkouts.length > 0 && dayWorkouts.every(w => w.completed);
                    const planned = dayWorkouts.length > 0;
                    
                    let barHeight = completed ? 'h-24' : planned ? 'h-16' : 'h-2';
                    let barColor = completed ? 'bg-green-500' : planned ? 'bg-purple-500/50' : 'bg-gray-700';
                    if (day.isSame(dayjs(), 'day')) barColor += ' pulsate';

                    const dayEl = document.createElement('div');
                    dayEl.className = 'flex flex-col items-center gap-2 flex-1';
                    dayEl.innerHTML = `<div class="w-full ${barHeight} ${barColor} rounded-t-md transition-all duration-500" title="${day.format('MMM D')}"></div><span class="text-xs font-bold text-gray-400">${day.format('ddd')}</span>`;
                    allElements.progressContainer.appendChild(dayEl);
                }
            };
            
            const renderTemplates = () => {
                allElements.templateList.innerHTML = '';
                WORKOUT_TEMPLATES.forEach(template => {
                    const templateEl = document.createElement('div');
                    templateEl.className = 'glass-card p-4 rounded-lg cursor-pointer hover:border-purple-400';
                    templateEl.dataset.templateName = template.name;
                    templateEl.innerHTML = `<h3 class="font-bold text-white text-lg">${template.name}</h3><p class="text-sm text-gray-400">${template.plan.map(p => p.type).join(', ')}</p>`;
                    templateEl.addEventListener('click', () => handleTemplateSelect(template.name));
                    allElements.templateList.appendChild(templateEl);
                });
            };

            // --- EVENT HANDLERS & WORKFLOWS ---
            const attachWorkoutEventListeners = () => {
                document.querySelectorAll('.track-btn').forEach(btn => btn.onclick = (e) => handleTrack(e.currentTarget.dataset.id));
                document.querySelectorAll('.start-timer-btn').forEach(btn => btn.onclick = (e) => startDurationTimer(e.currentTarget.dataset.id));
                document.querySelectorAll('.log-btn').forEach(btn => btn.onclick = (e) => handleLog(e.currentTarget.dataset.id));
                document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = (e) => handleEdit(e.currentTarget.dataset.id));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = (e) => handleDelete(e.currentTarget.dataset.id));
            };
            
            const handleLog = (workoutId) => {
                 const workoutIndex = findWorkoutIndexById(workoutId);
                 if (workoutIndex > -1) {
                    workouts[selectedDate][workoutIndex].completed = true;
                    saveAndRerender();
                 }
            };
            
            const handleEdit = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;
                allElements.workoutModalTitle.textContent = "Edit Workout";
                allElements.workoutIdInput.value = workout.id;
                allElements.workoutNameInput.value = workout.name;
                allElements.workoutTypeInput.value = workout.type;
                allElements.workoutDurationInput.value = workout.duration;
                allElements.workoutSetsInput.value = workout.totalSets || '';
                allElements.setsInputContainer.style.display = workout.type === 'Strength' ? 'block' : 'none';
                openModal(allElements.workoutModal);
            };

            const handleDelete = (workoutId) => {
                workouts[selectedDate] = workouts[selectedDate].filter(w => w.id !== workoutId);
                saveAndRerender();
            };

            const handleTemplateSelect = (templateName) => {
                const template = WORKOUT_TEMPLATES.find(t => t.name === templateName);
                const startOfWeek = currentDate.startOf('week');
                template.plan.forEach(item => {
                    const date = startOfWeek.add(item.d, 'day').format('YYYY-MM-DD');
                    if (!workouts[date]) workouts[date] = [];
                    workouts[date].push({ 
                        id: `workout-${Date.now()}-${Math.random()}`, 
                        name: item.n, 
                        type: item.type, 
                        duration: item.min,
                        totalSets: item.sets || 0,
                        setsData: item.sets ? Array(item.sets).fill({ weight: '', reps: '', completed: false }) : [],
                        completed: false 
                    });
                });
                closeModal(allElements.templateModal);
                saveAndRerender();
            };

            // --- DIET PLANNER LOGIC ---
            const generateAndShowDietPlan = (preference, goal) => {
                const plan = DIET_PLANS[preference]?.[goal];
                if (!plan) return;

                allElements.dietPlanTitle.textContent = plan.title;
                
                let contentHTML = '';
                for (const meal in plan.meals) {
                    contentHTML += `
                        <div class="border-l-4 border-emerald-500 pl-4">
                            <h3 class="font-bold text-white">${meal}</h3>
                            <p class="text-gray-400">${plan.meals[meal]}</p>
                        </div>
                    `;
                }
                allElements.dietPlanContent.innerHTML = contentHTML;
                openModal(allElements.dietPlanModal);
            };

            // --- TRACKER MODAL LOGIC ---
            const handleTrack = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;
                
                currentWorkoutId = workoutId;
                // Find the first uncompleted set to start with
                let firstUncompleted = workout.setsData.findIndex(s => !s.completed);
                currentSetIndex = firstUncompleted === -1 ? 0 : firstUncompleted;

                allElements.trackerModalTitle.textContent = workout.name;
                renderTrackerState();
                openModal(allElements.trackerModal);
            };

            const renderTrackerState = () => {
                const workout = findWorkoutById(currentWorkoutId);
                if (!workout) return;

                // Hide rest view, show set view
                allElements.trackerSetView.classList.remove('hidden');
                allElements.trackerRestView.classList.add('hidden');
                
                allElements.trackerProgressHeader.textContent = `Set ${currentSetIndex + 1} of ${workout.totalSets}`;
                
                const currentSetData = workout.setsData[currentSetIndex] || { weight: '', reps: '' };
                allElements.trackerWeightInput.value = currentSetData.weight;
                allElements.trackerRepsInput.value = currentSetData.reps;
                
                const prevSetData = workout.setsData[currentSetIndex - 1];
                if(prevSetData && prevSetData.completed) {
                    allElements.trackerPreviousSetData.textContent = `${prevSetData.reps} reps at ${prevSetData.weight} kg`;
                } else {
                     allElements.trackerPreviousSetData.textContent = '--';
                }

                allElements.prevSetBtn.disabled = currentSetIndex === 0;
                allElements.nextSetBtn.disabled = currentSetIndex === workout.totalSets - 1;
            };
            
            const logCurrentSetAndRest = () => {
                const workoutIndex = findWorkoutIndexById(currentWorkoutId);
                if(workoutIndex === -1) return;

                const weight = allElements.trackerWeightInput.value;
                const reps = allElements.trackerRepsInput.value;
                
                if(!weight || !reps) return; // Basic validation

                let workout = workouts[selectedDate][workoutIndex];
                workout.setsData[currentSetIndex] = { weight, reps, completed: true };
                
                saveAndRerender();
                
                // If it's the last set, don't start rest timer
                if(currentSetIndex >= workout.totalSets - 1) {
                    renderTrackerState();
                    return;
                }

                allElements.trackerSetView.classList.add('hidden');
                allElements.trackerRestView.classList.remove('hidden');
                runRestCountdown(60);
            };

            const runRestCountdown = (duration) => {
                clearInterval(restTimerInterval);
                restTimeRemaining = duration;

                const updateDisplay = () => {
                    const minutes = String(Math.floor(restTimeRemaining / 60)).padStart(2, '0');
                    const seconds = String(restTimeRemaining % 60).padStart(2, '0');
                    allElements.restTimerDisplay.textContent = `${minutes}:${seconds}`;
                };

                updateDisplay();

                restTimerInterval = setInterval(() => {
                    restTimeRemaining--;
                    updateDisplay();
                    if (restTimeRemaining <= 0) {
                        clearInterval(restTimerInterval);
                        goToNextSet();
                    }
                }, 1000);
            };

            const goToNextSet = () => {
                clearInterval(restTimerInterval);
                const workout = findWorkoutById(currentWorkoutId);
                if (workout && currentSetIndex < workout.totalSets - 1) {
                    currentSetIndex++;
                    renderTrackerState();
                }
            };
            
            // --- DURATION TIMER (CARDIO, ETC.) LOGIC ---
            const startDurationTimer = (workoutId) => {
                const workout = findWorkoutById(workoutId);
                if (!workout) return;
                
                clearInterval(timerInterval);
                timeRemaining = workout.duration * 60;
                totalTime = timeRemaining;
                isPaused = false;
                allElements.timerWorkoutName.textContent = workout.name;
                allElements.playIcon.classList.add('hidden');
                allElements.pauseIcon.classList.remove('hidden');
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    if (!isPaused) {
                        timeRemaining--;
                        updateTimerDisplay();
                        if (timeRemaining <= 0) {
                            clearInterval(timerInterval);
                            const workoutIndex = findWorkoutIndexById(workoutId);
                            if (workoutIndex > -1) workouts[selectedDate][workoutIndex].completed = true;
                            saveAndRerender();
                            setTimeout(() => closeModal(allElements.timerModal), 1000);
                        }
                    }
                }, 1000);
                openModal(allElements.timerModal);
            };

            const updateTimerDisplay = () => {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                allElements.timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                const progress = (totalTime - timeRemaining) / totalTime;
                allElements.timerProgressCircle.style.strokeDashoffset = 283 * (1 - progress);
            };

            const pauseResumeTimer = () => {
                isPaused = !isPaused;
                allElements.playIcon.classList.toggle('hidden', !isPaused);
                allElements.pauseIcon.classList.toggle('hidden', isPaused);
            };
            
            const stopTimer = () => {
                clearInterval(timerInterval);
                closeModal(allElements.timerModal);
            };

            // --- INITIALIZATION ---
            const init = () => {
                allElements.currentDateEl.textContent = dayjs().format('dddd, MMMM D');
                renderCalendar();
                renderWorkouts();
                renderProgress();
                renderTemplates();
                renderMotivation();

                // General Event Listeners
                document.getElementById('prev-week').addEventListener('click', () => { currentDate = currentDate.subtract(1, 'week'); renderCalendar(); });
                document.getElementById('next-week').addEventListener('click', () => { currentDate = currentDate.add(1, 'week'); renderCalendar(); });
                document.getElementById('add-workout-btn').addEventListener('click', () => {
                    allElements.workoutModalTitle.textContent = "Add New Workout";
                    allElements.workoutForm.reset();
                    allElements.workoutIdInput.value = '';
                    allElements.setsInputContainer.style.display = 'block';
                    openModal(allElements.workoutModal);
                });
                document.getElementById('workout-templates-card').addEventListener('click', () => openModal(allElements.templateModal));
                
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    closeModal(modal);
                    if(modal.id === 'tracker-modal') saveAndRerender();
                }));
                document.querySelectorAll('.fixed').forEach(modal => modal.addEventListener('click', (e) => { 
                    if (e.target === modal) {
                        closeModal(modal);
                        if(modal.id === 'tracker-modal') saveAndRerender();
                    }
                }));

                allElements.workoutTypeInput.addEventListener('change', (e) => {
                    allElements.setsInputContainer.style.display = e.target.value === 'Strength' ? 'block' : 'none';
                });
                
                allElements.workoutForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = allElements.workoutIdInput.value || `workout-${Date.now()}-${Math.random()}`;
                    const type = allElements.workoutTypeInput.value;
                    const totalSets = type === 'Strength' ? parseInt(allElements.workoutSetsInput.value) || 0 : 0;
                    
                    const workoutData = {
                        id: id,
                        name: allElements.workoutNameInput.value,
                        type: type,
                        duration: allElements.workoutDurationInput.value,
                        totalSets: totalSets,
                    };
                    
                    if (!workouts[selectedDate]) workouts[selectedDate] = [];
                    const existingIndex = findWorkoutIndexById(id);
                    
                    if (existingIndex > -1) {
                        const existingWorkout = workouts[selectedDate][existingIndex];
                        if(existingWorkout.totalSets !== totalSets) {
                            const newSetsData = Array(totalSets).fill({ weight: '', reps: '', completed: false });
                            for(let i=0; i < Math.min(existingWorkout.totalSets || 0, totalSets); i++) {
                                newSetsData[i] = existingWorkout.setsData[i];
                            }
                            workoutData.setsData = newSetsData;
                        }
                        workouts[selectedDate][existingIndex] = { ...existingWorkout, ...workoutData };
                    } else {
                        workoutData.completed = false;
                        workoutData.setsData = Array(totalSets).fill({ weight: '', reps: '', completed: false });
                        workouts[selectedDate].push(workoutData);
                    }
                    closeModal(allElements.workoutModal);
                    saveAndRerender();
                });
                
                // Tracker Modal Listeners
                document.getElementById('log-set-btn').addEventListener('click', logCurrentSetAndRest);
                document.getElementById('prev-set-btn').addEventListener('click', () => {
                    if (currentSetIndex > 0) {
                        currentSetIndex--;
                        renderTrackerState();
                    }
                });
                document.getElementById('next-set-btn').addEventListener('click', goToNextSet);
                document.getElementById('skip-rest-btn').addEventListener('click', goToNextSet);
                document.getElementById('add-time-btn').addEventListener('click', () => runRestCountdown(restTimeRemaining + 30));
                document.getElementById('finish-workout-btn').addEventListener('click', () => {
                    const workoutIndex = findWorkoutIndexById(currentWorkoutId);
                    if(workoutIndex > -1) workouts[selectedDate][workoutIndex].completed = true;
                    closeModal(allElements.trackerModal);
                    saveAndRerender();
                });

                // Diet Planner Listeners
                allElements.dietPlannerCard.addEventListener('click', () => openModal(allElements.dietCreatorModal));
                allElements.dietCreatorForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const preference = document.getElementById('diet-preference').value;
                    const goal = document.getElementById('diet-goal').value;
                    generateAndShowDietPlan(preference, goal);
                    closeModal(allElements.dietCreatorModal);
                });


                // Duration Timer Listeners
                allElements.pauseResumeBtn.addEventListener('click', pauseResumeTimer);
                document.getElementById('stop-timer-btn').addEventListener('click', stopTimer);

                setInterval(() => allElements.currentDateEl.textContent = dayjs().format('dddd, MMMM D'), 60000);
            };

            init();
        });
    </script>

</body>
</html>

